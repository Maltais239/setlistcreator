<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setlist Creator 3.0.2</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Mammoth.js for DOCX support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* --- DRAG & DROP STYLES --- */
        .drag-handle { 
            cursor: grab; 
            padding: 12px 18px; /* Touch target */
            font-size: 1.5rem;
            touch-action: none; /* CRITICAL for mobile */
            color: #6b7280;
            transition: color 0.2s;
        }
        .drag-handle:active { cursor: grabbing; color: #818cf8; }
        
        /* The item currently being dragged (floating) */
        .sortable-drag { 
            opacity: 1 !important; 
            background: #1f2937 !important; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3) !important;
            transform: scale(1.02);
            border: 1px solid #818cf8;
            border-radius: 0.5rem;
            z-index: 9999;
        }
        
        /* The drop placeholder */
        .sortable-ghost { 
            opacity: 0.4; 
            background: #374151; 
            border: 2px dashed #6366f1; /* Indigo dashed border */
            border-radius: 0.5rem;
        }
        
        /* The item selected before drag starts */
        .sortable-chosen {
            background: #374151;
        }

        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .audience-song-button:active { transform: scale(0.98); }
        .glass { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    </style>

    <!-- MAIN APP SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, doc, setDoc, getDoc, updateDoc, increment, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // 1. DATA CONSTANTS & UTILS
        // ==========================================
        const MASTER_DB_URL = "https://raw.githubusercontent.com/Maltais239/interactives/main/master_song_database_cleaned.json";
        const createSongObject = (title, durationStr = "0:00") => ({ title, durationStr });

        const rawBankData = ["A Little Something (Melissa Majeau)", "A Simple Thing (Darren Maltais)", "Ahead By A Century (Tragically Hip)", "All Apologies (Nirvana)", "American Girl (Tom Petty)", "Another Road Home (Jeff McLellan)", "Back To Black (Amy Winehouse)", "Beautiful things (Darren Maltais)", "Before Our Graves (Jeff McLellan)", "Big River (Johnny Cash)", "Blank Space (Ryan Adams)", "Blindman River (Melissa Majeau)", "Blister In The Sun (Violent Femmes)", "Blitzkrieg Bop (The Ramones)", "Blow At High Dough (Tragically Hip)", "Blue Christmas (Elvis Presley)", "Bobcaygeon (Tragically Hip)", "Bottom Feeders (Melissa Majeau)", "Brown Eyed Girl (Van Morrison)", "Cadillac Ranch (Nitty Gritty Dirt Band)", "Can't Let Go (Lucinda Williams)", "Christmas (Baby Please Come Home) (Darlene Love)", "Cleopatra (The Lumineers)", "Colors (Black Pumas)", "Copperhead Road (Steve Earle)", "Creep (Radiohead)", "Cry Me A River (Justin Timberlake)", "Dancing In The Dark (Bruce Springsteen)", "Day Tripper (The Beatles)", "Don't Want to Wait (Darren Maltais)", "Dont Walk Away Eileen (Sam Roberts)", "Dreams (Fleetwood Mac)", "Driving My Life Away (Eddie Rabbitt)", "Faith (Wham)", "Fishin' In The Dark (Nitty Gritty Dirt Band)", "Five Dollar Bill (Corb Lund)", "Flowers (Miley Cyrus)", "Flowers In Your Hair (The Lumineers)", "Folsom Prison Blues (Johnny Cash)", "Friends in Low Places (Garth Brooks)", "Get Back (The Beatles)", "Green River (CCR)", "Guitar Town (Steve Earle)", "Hand it over (Darren Maltais)", "Harvest Moon (Neil Young)", "Heart of Glass (Blondie)", "Hungry Like The Wolf (Duran Duran)", "I Need Never Get Old (Nathaniel Rateliff)", "I Shot To Sheriff (Bob Marley)", "I Walk The Line (Johnny Cash)", "I Wonder (Darren Maltais)", "I'm On Fire (Bruce Springsteen)", "Is Your Heart a Map (Darren Maltais)", "Island In The Sun (Weezer)", "It Takes a Lot to Laugh (Bob Dylan)", "Jambalaya (Hank Williams Sr.)", "Jingle Bell Rock (Bobby Helms)", "Johnny B. Goode (Chuck Berry)", "Jolene (Dolly Parton)", "Just Another Number (Darren Maltais)", "King Of The Road (Dean Martin/Roger Miller)", "Layla (Derek and the Dominos)", "Life Of Sin (Sturgill Simpson)", "Little Bones (Tragically Hip)", "Little Lion Man (Mumford & Sons)", "Lonesome Grave (Darren Maltais)", "Long Ride (Melissa Majeau)", "Looking Out My Back Door", "Memento (Darren Maltais)", "Midnight Rider (Allman Brothers Band)", "My Babe (Willie Dixon / Little Walter)", "No Bright Light (Darren Maltais)", "No Denial (Melissa Majeau)", "No Diggity (Blackstreet)", "Norwegian Wood (The Beatles)", "Oh Boy (Buddy Holly)", "Paper Planes (M.I.A.)", "Paranoid (Black Sabbath)", "Pride And Joy (Stevie Ray Vaughan)", "REAL LOVE BABY (Father John Misty)", "Rhiannon (Fleetwood Mac)", "Ring of Fire (Johnny Cash)", "Rocket Man (Elton John)", "Runaround Sue (Dion)", "Santa Bring My Baby Back To Me (Elvis)", "Santa Claus Is Coming To Town (Bruce Springsteen)", "Seven Nation Army (The White Stripes)", "S.O.B. (Nathaniel Rateliff)", "Something In The Orange (Zach Bryan)", "Spark (Darren Maltais)", "Steal My Kisses (Ben Harper)", "Still Falling (Jeff McLellan)", "Sugar Daddy (Melissa Majeau)", "Tennessee Whiskey (Chris Stapleton)", "That's All Right Mama (Elvis Presley)", "The Thrill Is Gone (BB King)", "Those Days (Darren Maltais)", "Tonight in Black and White (Jeff McLellan)", "Twist and Shout (The Beatles)", "Wagon Wheel (Old Crow Medicine Show)", "What'd I Say (Ray Charles)", "You Can't Judge A Book By The Cover (Bo Diddley)", "You Wreck Me (Tom Petty)", "Zombie (The Cranberries)"];
        
        const christmasSongs = ["Baby Its Cold Outside", "Blue Christmas", "Christmas (Baby Please Come Home)", "CHRISTMAS ALL OVER AGAIN CHORDS", "Fairytale of New York...", "Happy Xmas War Is Over", "Here Comes Santa Claus", "Holly Jolly Christmas", "Ill Be Home For Christmas", "It's Beginning To Look A Lot Like Christmas", "It's The Most Wonderful Time Of The Year", "Jingle Bell Rock", "Jingle Bells", "Last Christmas", "Let It Snow", "Marshmallow World", "Mele Kalikimaka", "Rocking Around The Christmas Tree", "Rudolph The Red-Nosed Reindeer", "Run Rudolph Run", "Santa Bring My Baby Back To Me", "Santa Claus Is Coming To Town", "Silent Night", "Silver Bells", "Sleigh Ride", "White Christmas", "Winter Wonderland"];
        
        const songMetadata = {
            "5 Days In May": { k: "Em", c: "" }, "50 Ways To Leave Your Lover": { k: "Em", c: "" }, "54 46 Was My Number": { k: "G", c: "" }, "6th Avenue Heartache": { k: "G", c: "" }, "Zombie": { k: "Em", c: "" }
        };

        // --- STATE INIT ---
        let savedRotation = localStorage.getItem('myActiveRotation');
        let activeRotationList = savedRotation ? JSON.parse(savedRotation) : rawBankData.sort();
        window.activeRotationList = activeRotationList;
        
        let fullSongDatabase = []; 
        let holidayBank = rawBankData.filter(s => christmasSongs.some(c => s.toLowerCase().includes(c.toLowerCase()))).sort();
        let fullDatabaseKeys = Object.keys(songMetadata).sort();
        
        // --- DATA SETUP ---
        const currentSetData = [
            ["Cleopatra (The Lumineers)", "Island In The Sun (Weezer)", "Ahead By A Century (Tragically Hip)", "Dont Walk Away Eileen (Sam Roberts)", "A Little Something (Melissa Majeau)", "Green River (CCR)", "Flowers (Miley Cyrus)", "Dancing In The Dark (Bruce Springsteen)", "Blow At High Dough (Tragically Hip)", "All Apologies (Nirvana)", "I Need Never Get Old (Nathaniel Rateliff)", "Dreams (Fleetwood Mac)", "Folsom Prison Blues (Johnny Cash)", "My Babe (Willie Dixon / Little Walter)", "Harvest Moon (Neil Young)", "Jolene (Dolly Parton)", "Colors (Black Pumas)"], 
            ["Something In The Orange (Zach Bryan)", "Don't Want to Wait (Darren Maltais)", "Layla (Derek and the Dominos)", "I'm On Fire (Bruce Springsteen)", "Those Days (Darren Maltais)", "You Wreck Me (Tom Petty)", "Steal My Kisses (Ben Harper)", "Blank Space (Ryan Adams)", "Pride And Joy (Stevie Ray Vaughan)", "Tonight in Black and White (Jeff McLellan)", "REAL LOVE BABY (Father John Misty)", "Five Dollar Bill (Corb Lund)", "Cadillac Ranch (Nitty Gritty Dirt Band)", "American Girl (Tom Petty)", "Get Back (The Beatles)", "King Of The Road (Dean Martin/Roger Miller)", "Heart of Glass (Blondie)", "Johnny B. Goode (Chuck Berry)", "Rhiannon (Fleetwood Mac)", "No Bright Light (Darren Maltais)", "Blister In The Sun (Violent Femmes)"], 
            ["Cry Me A River (Justin Timberlake)", "Back To Black (Amy Winehouse)", "Can't Let Go (Lucinda Williams)", "No Diggity (Blackstreet)", "I Shot To Sheriff (Bob Marley)", "Hand it over (Darren Maltais)", "That's All Right Mama (Elvis Presley)", "Runaround Sue (Dion)", "Zombie (The Cranberries)", "You Can't Judge A Book By The Cover (Bo Diddley)", "Fishin' In The Dark (Nitty Gritty Dirt Band)", "Paper Planes (M.I.A.)", "Blitzkrieg Bop (The Ramones)", "Day Tripper (The Beatles)", "Driving My Life Away (Eddie Rabbitt)", "Beautiful things (Darren Maltais)", "Blindman River (Melissa Majeau)", "Tennessee Whiskey (Chris Stapleton)", "Another Road Home (Jeff McLellan)", "Oh Boy (Buddy Holly)", "Life Of Sin (Sturgill Simpson)", "Hungry Like The Wolf (Duran Duran)"], 
            ["Paranoid (Black Sabbath)", "It Takes a Lot to Laugh (Bob Dylan)", "Flowers In Your Hair (The Lumineers)", "Faith (Wham)", "Still Falling (Jeff McLellan)", "Driving My Life Away (Reprise?)", "Norwegian Wood (The Beatles)", "Bottom Feeders (Melissa Majeau)", "Creep (Radiohead)", "S.O.B. (Nathaniel Rateliff)", "What'd I Say (Ray Charles)", "Long Ride (Melissa Majeau)", "The Thrill Is Gone (BB King)", "Rocket Man (Elton John)"]
        ].map(set => set.map(t => createSongObject(t)));
        
        const originalsData = [[],[],[],[]];
        const jeffSongs = ["Tonight in Black and White (Jeff McLellan)", "Still Fallin' (Jeff McLellan)", "Before Our Graves (Jeff McLellan)", "Another Road Home (Jeff McLellan)", "Havens to Hendrix (Jeff McLellan)", "Blindman River (Jeff McLellan)"];
        const melissaSongs = ["A Little Something (Melissa Majeau)", "Blindman River (Melissa Majeau)", "Bottom Feeders (Melissa Majeau)", "Long Ride (Melissa Majeau)", "No Denial (Melissa Majeau)", "Sugar Daddy (Melissa Majeau)"];
        const darrenSongs = ["Spark (Darren Maltais)", "No Bright Light (Darren Maltais)", "Hand it Over (Darren Maltais)", "Beautiful Things (Darren Maltais)", "Don't Want to Wait (Darren Maltais)", "A Simple Thing (Darren Maltais)", "Is Your Heart a Map (Darren Maltais)", "Just Another Number (Darren Maltais)", "Lonesome Grave (Darren Maltais)", "I Wonder (Darren Maltais)", "Memento (Darren Maltais)"];
        originalsData[0] = jeffSongs.map(t => createSongObject(t)); originalsData[1] = melissaSongs.map(t => createSongObject(t)); originalsData[2] = darrenSongs.map(t => createSongObject(t));

        let customData = [[], [], [], []];
        if(localStorage.getItem('myCustomSets')) { try { customData = JSON.parse(localStorage.getItem('myCustomSets')); } catch(e) {} }

        let currentTab = 'current'; 
        
        // GLOBAL SET COLLECTIONS
        window.setCollections = {
            current: JSON.parse(JSON.stringify(currentSetData)),
            custom: customData,
            originals: JSON.parse(JSON.stringify(originalsData)),
            collaborate: [[],[],[],[]], 
            live: [[],[],[],[]],
            database: [[],[],[],[]] 
        };
        
        let sortables = [];
        window.managerMode = false;

        // ==========================================
        // 2. FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB-_e71_7lTDjU4zBCCnunGIRyf2zyTvhw",
            authDomain: "set-list-creator-ef3d8.firebaseapp.com",
            projectId: "set-list-creator-ef3d8",
            storageBucket: "set-list-creator-ef3d8.firebasestorage.app",
            messagingSenderId: "221159083280",
            appId: "1:221159083280:web:b39791e126d8282d176995",
            measurementId: "G-S31RSM312F"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'setlist-v2-demo';

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.doc = doc;
            window.setDoc = setDoc;
            window.getDoc = getDoc;
            window.collection = collection;
            window.addDoc = addDoc;
            window.updateDoc = updateDoc;
            window.increment = increment;
            window.deleteDoc = deleteDoc;
            window.query = query;
            window.where = where;
            window.getDocs = getDocs;
            window.writeBatch = writeBatch;
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        // ==========================================
        // 3. CORE LOGIC & HELPERS (DEFINED EARLY)
        // ==========================================
        window.showToast = (msg, isError = false) => {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            if(!toast || !msgEl) return;
            msgEl.textContent = msg;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'} text-white translate-y-0 opacity-100`;
            setTimeout(() => {
                toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'} text-white translate-y-20 opacity-0`;
            }, 3000);
        };

        window.updateCollaboration = async () => {
             if (!db) return;
             const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'collaboration', 'sets');
             try {
                 if(!window.setCollections.collaborate || window.setCollections.collaborate.length !== 4) {
                     window.setCollections.collaborate = [[],[],[],[]];
                 }
                 await setDoc(docRef, { 
                     sets: JSON.stringify(window.setCollections.collaborate), 
                     lastUpdated: Date.now() 
                 }, { merge: true });
                 console.log("Collaboration synced");
             } catch (e) {
                 console.error("Sync error", e);
             }
        };
        
        window.getSongMetadata = (titleStr) => {
            if (songMetadata[titleStr]) return songMetadata[titleStr];
            const lower = titleStr.toLowerCase();
            const foundKey = Object.keys(songMetadata).find(k => k.toLowerCase() === lower);
            if (foundKey) return songMetadata[foundKey];
            const subKey = Object.keys(songMetadata).find(k => k.toLowerCase().includes(lower) || lower.includes(k.toLowerCase()));
            if (subKey) return songMetadata[subKey];
            return null;
        };

        const singerMap = { "Ahead By A Century": "Jeff", "Blow At High Dough": "Jeff", "All Apologies": "Jeff", "ALL APOLOGIES": "Jeff", "I'm On Fire": "D/M", "Dreams": "Melissa", "Jolene": "Melissa", "Heart of Glass": "Melissa", "Rhiannon": "Melissa", "Blister In The Sun": "Jeff", "Can't Let Go": "Melissa", "Cant Let Go": "Melissa", "I Shot To Sheriff": "Jeff", "You Wreck Me": "Jeff", "Norwegian Wood": "Jeff", "Johnny B. Goode": "Jeff", "Johnny B Goode": "Jeff", "Brown Eyed Girl": "Jeff", "Cadillac Ranch": "Jeff", "Flowers": "Melissa", "Valerie": "Melissa", "Layla": "Jeff", "Blindman River": "Melissa", "Zombie": "Melissa" };

        function getSinger(titleStr) {
            if (!titleStr) return "Darren";
            const cleanTitle = titleStr.toLowerCase();
            for (const [key, value] of Object.entries(singerMap)) {
                if (cleanTitle.includes(key.toLowerCase())) { return value; }
            }
            if (cleanTitle.includes("jeff mclellan")) return "Jeff";
            if (cleanTitle.includes("melissa majeau")) return "Melissa";
            if (cleanTitle.includes("darren maltais")) return "Darren";
            return "Darren";
        }
        
        function getSingerBadgeHTML(singer) {
            if (singer === 'Jeff') return `<span class="singer-badge inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-500/20 text-blue-400 text-xs font-bold mr-2 no-print flex-shrink-0" title="Jeff">J</span>`;
            if (singer === 'Melissa') return `<span class="singer-badge inline-flex items-center justify-center w-6 h-6 rounded-full bg-pink-500/20 text-pink-400 text-xs font-bold mr-2 no-print flex-shrink-0" title="Melissa">M</span>`;
            if (singer === 'D/M') return `<span class="singer-badge inline-flex items-center justify-center w-8 h-6 rounded-full bg-gradient-to-r from-green-500/20 to-pink-500/20 text-white text-[10px] font-bold mr-2 no-print flex-shrink-0" title="Duet">D/M</span>`;
            return `<span class="singer-badge inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-500/20 text-green-400 text-xs font-bold mr-2 no-print flex-shrink-0" title="Darren">D</span>`;
        }

        function filterSongsAgainstMasterBank(songList) {
            const masterTitles = new Set(activeRotationList.map(s => s.toLowerCase()));
            return {
                inBank: songList.filter(s => masterTitles.has(s.title.toLowerCase())),
                notInBank: songList.filter(s => !masterTitles.has(s.title.toLowerCase()))
            };
        }

        // ==========================================
        // 4. RENDER & DOM MANIPULATION
        // ==========================================
        window.renderBank = () => {
            const searchInput = document.getElementById('bank-search');
            const bankTitle = document.getElementById('bank-title');
            const lockIcon = document.getElementById('manager-lock-icon');
            
            if(lockIcon) lockIcon.textContent = window.managerMode ? 'üîì' : 'üîí';

            const search = searchInput ? searchInput.value.toLowerCase() : ''; 
            const listEl = document.getElementById('bank-list');
            if(!listEl) return;
            
            let sourceList;
            let showHolidaySection = false; 
            let isDatabaseTab = currentTab === 'database';

            if (isDatabaseTab) {
                sourceList = fullSongDatabase; 
                bankTitle.textContent = "Full Song Database (" + fullSongDatabase.length + ")";
                showHolidaySection = false; 
            } else {
                sourceList = activeRotationList; 
                bankTitle.textContent = "Active Rotation (" + activeRotationList.length + ")";
                showHolidaySection = true; 
            }

            const filtered = sourceList.filter(s => s.toLowerCase().includes(search));
            let html = filtered.map(s => renderSongRow(s, isDatabaseTab)).join('');

            if (showHolidaySection) {
                const filteredHoliday = holidayBank.filter(s => s.toLowerCase().includes(search));
                if (!search || (search && filteredHoliday.length > 0)) {
                    html += `
                        <div class="col-span-full mt-6 mb-2 border-b border-gray-700 pb-2">
                            <h3 class="text-red-400 font-bold uppercase text-xs tracking-wider">Holiday / Seasonal</h3>
                        </div>
                    `;
                    html += filteredHoliday.map(s => renderSongRow(s, false)).join('');
                }
            }
            listEl.innerHTML = html;
        };

        function renderSongRow(s, showAddButton) {
            const singer = getSinger(s);
            const badgeHTML = getSingerBadgeHTML(singer);
            let cleanTitle = s.split('(')[0].trim();
            const meta = window.getSongMetadata(cleanTitle) || window.getSongMetadata(s);
            let metaHTML = '';
            if(meta) {
                if(meta.k) metaHTML += `<span class="text-[10px] bg-gray-700 text-yellow-500 border border-yellow-500/30 px-1 rounded ml-2 font-mono">${meta.k}</span>`;
                if(meta.c) metaHTML += `<span class="text-[10px] bg-gray-700 text-cyan-400 border border-cyan-500/30 px-1 rounded ml-1 font-mono">Cp ${meta.c}</span>`;
            }

            let addToRotationBtn = '';
            let removeBtn = '';

            if (showAddButton) {
                const inRotation = activeRotationList.includes(s);
                if (!inRotation) {
                    if (window.managerMode) {
                        addToRotationBtn = `<button onclick="addToRotation('${s.replace(/'/g, "\\'")}')" class="text-[10px] bg-indigo-900 text-indigo-200 border border-indigo-700 hover:bg-indigo-700 w-6 h-6 rounded flex items-center justify-center mr-1" title="Add to Active Rotation">‚≠ê</button>`;
                    } else {
                        addToRotationBtn = '';
                    }
                } else {
                    addToRotationBtn = `<span class="text-[10px] text-green-500 w-6 h-6 flex items-center justify-center mr-1">‚úì</span>`;
                }
            } else if (window.managerMode) {
                removeBtn = `<button onclick="removeFromRotation('${s.replace(/'/g, "\\'")}')" class="text-[10px] bg-red-900/50 text-red-300 border border-red-800 hover:bg-red-700 w-6 h-6 rounded flex items-center justify-center mr-1" title="Remove from Rotation">üóëÔ∏è</button>`;
            }

            const safeTitle = s.replace(/'/g, "\\'").replace(/"/g, '&quot;');

            return `
            <div class="bg-gray-800 border border-gray-700 p-2 rounded flex justify-between items-center group hover:bg-gray-750">
                <div class="flex items-center overflow-hidden mr-2">
                    ${badgeHTML}
                    <span class="text-sm text-gray-300 truncate" title="${s}">${s}</span>
                    ${metaHTML}
                </div>
                <div class="flex gap-1 opacity-50 group-hover:opacity-100 transition-opacity">
                    ${addToRotationBtn}
                    ${removeBtn}
                    <button onclick="openLyricsModal('${safeTitle}', '')" class="text-[10px] bg-gray-700 hover:text-white hover:bg-gray-600 w-6 h-6 rounded flex items-center justify-center" title="View Lyrics">üìù</button>
                    <button onclick="addFromBank('${safeTitle}', 0)" class="text-[10px] bg-gray-700 hover:bg-indigo-600 w-5 h-5 rounded">1</button>
                    <button onclick="addFromBank('${safeTitle}', 1)" class="text-[10px] bg-gray-700 hover:bg-indigo-600 w-5 h-5 rounded">2</button>
                    <button onclick="addFromBank('${safeTitle}', 2)" class="text-[10px] bg-gray-700 hover:bg-indigo-600 w-5 h-5 rounded">3</button>
                    <button onclick="addFromBank('${safeTitle}', 3)" class="text-[10px] bg-gray-700 hover:bg-indigo-600 w-5 h-5 rounded">4</button>
                </div>
            </div>`;
        }

        window.addToRotation = (songName) => {
            if (!activeRotationList.includes(songName)) {
                activeRotationList.push(songName);
                activeRotationList.sort();
                localStorage.setItem('myActiveRotation', JSON.stringify(activeRotationList));
                showToast("Added to Active Rotation");
                renderBank(); 
            }
        };
        
        window.removeFromRotation = async (songName) => {
            if(!db) return;
            if(!window.managerMode) return showToast("Unlock Manager Mode to edit rotation.", true);
            
            if(!confirm(`Remove "${songName}" from Active Rotation?`)) return;

            const currentList = window.activeRotationList || activeRotationList;
            const newList = currentList.filter(s => s !== songName).sort();
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rotation', 'list');
                await setDoc(docRef, { songs: newList, lastUpdated: Date.now() });
                activeRotationList = newList;
                window.activeRotationList = newList;
                localStorage.setItem('myActiveRotation', JSON.stringify(activeRotationList));
                showToast("Removed from Rotation");
                renderBank();
            } catch(e) { console.error(e); showToast("Error saving to cloud", true); }
        };

        window.addFromBank = (t, i) => {
            if(!window.setCollections[currentTab] || !window.setCollections[currentTab][i]) return showToast("Error: Set not available", true);
            window.setCollections[currentTab][i].push({title: t, durationStr: "0:00"});
            if(currentTab === 'custom') {
                localStorage.setItem('myCustomSets', JSON.stringify(window.setCollections.custom));
            } else if (currentTab === 'collaborate') {
                window.updateCollaboration();
            }
            showToast("Added to Set " + (i+1));
            render();
        };

        window.addNewSong = () => {
            const titleInput = document.getElementById('song-title');
            const setSelect = document.getElementById('target-set');
            const title = titleInput.value.trim();
            const setIdx = parseInt(setSelect.value);
            if(title) {
                if(!window.setCollections[currentTab] || !window.setCollections[currentTab][setIdx]) return showToast("Set not available", true);
                window.setCollections[currentTab][setIdx].push({title: title, durationStr: "0:00"});
                if(currentTab === 'custom') {
                    localStorage.setItem('myCustomSets', JSON.stringify(window.setCollections.custom));
                } else if (currentTab === 'collaborate') {
                    window.updateCollaboration();
                }
                titleInput.value = '';
                showToast("Song added!");
                render();
            }
        };

        window.deleteSong = (setIndex, songIndex) => {
            window.setCollections[currentTab][setIndex].splice(songIndex, 1);
            if(currentTab === 'custom') {
                localStorage.setItem('myCustomSets', JSON.stringify(window.setCollections.custom));
            } else if (currentTab === 'collaborate') {
                window.updateCollaboration();
            }
            render();
        };

        window.handleDragDrop = (evt) => {
            for(let i=0; i<4; i++) {
                const list = document.getElementById(`list-set-${i}`);
                if(!list) continue;
                const items = Array.from(list.children)
                    .filter(li => li.hasAttribute('data-title'))
                    .map(li => {
                        return { title: li.getAttribute('data-title'), durationStr: "0:00" };
                    });
                window.setCollections[currentTab][i] = items;
            }
            if(currentTab === 'custom') {
                localStorage.setItem('myCustomSets', JSON.stringify(window.setCollections.custom));
            } else if (currentTab === 'collaborate') {
                window.updateCollaboration();
            }
            render(); 
        };

        function render() {
            sortables.forEach(s => s.destroy());
            sortables = [];
            const activeSets = window.setCollections[currentTab];

            for(let i=0; i<4; i++) {
                const listEl = document.getElementById(`list-set-${i}`);
                const container = document.getElementById(`set-container-${i}`);
                const headerDiv = container.querySelector('.p-4');
                if(!listEl) continue;
                container.classList.remove('hidden'); 
                
                let setSongs = activeSets[i];
                let notInBank = [];

                if (i === 0 && currentTab === 'current') {
                    const filtered = filterSongsAgainstMasterBank(activeSets[i]); 
                    setSongs = filtered.inBank;
                    notInBank = filtered.notInBank;
                }

                const title = `Set ${i + 1}`;
                const copyBtn = currentTab !== 'custom' && currentTab !== 'collaborate' ? `<button onclick="openCopyModal(${i})" class="text-indigo-400 hover:text-white p-1 ml-2 text-xs font-bold" title="Copy">COPY</button>` : '';
                
                let headerContent = `
                    <div class="flex items-center justify-between w-full"> 
                        <h2 class="text-xl font-bold text-green-400">${title}</h2>
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-gray-400 bg-gray-900 px-2 py-1 rounded text-sm set-time-badge" style="display: none;">0:00</span>
                            <div class="flex gap-1 no-print">
                                ${copyBtn}
                                <button onclick="downloadSetImage(${i})" class="text-gray-400 hover:text-white p-1 text-xl leading-none" title="Save Image">&#x1F4F8;</button>
                            </div>
                        </div>
                    </div>`;

                if (currentTab === 'current' && i === 0 && notInBank.length > 0) {
                    const suggestionList = notInBank.map(s => s.title).join(', ');
                    headerContent += `<div class="mt-3 bg-red-900/30 p-2 rounded-lg text-xs text-red-300 border border-red-700"><span class="font-bold">Other Suggestions:</span><p class="italic">${suggestionList}</p></div>`;
                }
                headerDiv.innerHTML = headerContent;

                listEl.innerHTML = '';
                if(setSongs && setSongs.length === 0) {
                    listEl.innerHTML = `<li class="p-4 text-gray-500 text-center text-sm italic">Empty Set</li>`;
                } else if (setSongs) {
                    setSongs.forEach((song, idx) => {
                        if (!song || !song.title) return;
                        const singer = getSinger(song.title);
                        const badgeHTML = getSingerBadgeHTML(singer);
                        let cleanTitle = song.title.split('(')[0].trim();
                        const meta = window.getSongMetadata(cleanTitle) || window.getSongMetadata(song.title);
                        let metaHTML = '';
                        if(meta) {
                            if(meta.k) metaHTML += `<span class="text-[10px] bg-gray-700 text-yellow-500 border border-yellow-500/30 px-1 rounded ml-2 font-mono">${meta.k}</span>`;
                            if(meta.c) metaHTML += `<span class="text-[10px] bg-gray-700 text-cyan-400 border border-cyan-500/30 px-1 rounded ml-1 font-mono">Cp ${meta.c}</span>`;
                        }
                        const safeTitle = song.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                        listEl.innerHTML += `
                            <li class="group flex items-center justify-between p-3 hover:bg-gray-750 transition border-l-4 border-transparent hover:border-indigo-500 bg-gray-800 odd:bg-gray-800 even:bg-gray-800/50" data-title="${song.title}">
                                <div class="flex items-center gap-3 overflow-hidden flex-grow">
                                    <div class="drag-handle cursor-grab text-gray-600 hover:text-gray-400 no-print">‚ò∞</div>
                                    <span class="text-gray-500 font-mono text-xs w-5 text-right no-print select-none">${idx + 1}.</span>
                                    <div class="truncate text-gray-200 text-sm md:text-base print-black flex items-center" title="${song.title}">
                                        ${badgeHTML}
                                        ${song.title}
                                        ${metaHTML}
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0 no-print">
                                    <button onclick="openLyricsModal('${safeTitle}', '')" class="text-gray-500 hover:text-white p-1" title="Lyrics/Chords">üìù</button>
                                    <button onclick="deleteSong(${i}, ${idx})" class="p-1 hover:text-red-400 text-gray-600 opacity-0 group-hover:opacity-100 transition">√ó</button>
                                </div>
                            </li>`;
                    });
                }
            }
            
            for(let i=0; i<4; i++) {
                const el = document.getElementById(`list-set-${i}`);
                if(el) sortables.push(new Sortable(el, { 
                    group: 'shared', 
                    animation: 200, 
                    delay: 150, 
                    delayOnTouchOnly: true,
                    handle: '.drag-handle', 
                    ghostClass: 'sortable-ghost', 
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onChoose: function (evt) {
                        if (navigator.vibrate) navigator.vibrate(50);
                    },
                    onEnd: handleDragDrop 
                }));
            }
        }

        // ==========================================
        // 5. TABS & UI HANDLERS
        // ==========================================
        window.switchTab = (tabId) => {
            currentTab = tabId;
            const customControls = document.getElementById('custom-controls');
            const liveControls = document.getElementById('live-controls');
            const setsArea = document.getElementById('sets-capture-area');
            const inputSection = document.getElementById('input-section');
            const songBank = document.getElementById('song-bank-section');
            const bankTitle = document.querySelector('#song-bank-section h2');
            const collabInfo = document.getElementById('collaborate-info');
            
            customControls.classList.add('hidden');
            liveControls.classList.add('hidden');
            setsArea.classList.remove('hidden');
            inputSection.classList.remove('hidden');
            songBank.classList.add('hidden'); 
            collabInfo.classList.add('hidden');

            if(tabId === 'custom') customControls.classList.remove('hidden');
            if(tabId === 'collaborate') collabInfo.classList.remove('hidden');
            
            if(tabId === 'live') {
                liveControls.classList.remove('hidden');
                setsArea.classList.add('hidden');
                inputSection.classList.add('hidden');
                generateQR();
            }
            
            if(tabId === 'database') {
                setsArea.classList.add('hidden'); 
                inputSection.classList.add('hidden'); 
                songBank.classList.remove('hidden'); 
                if(bankTitle) bankTitle.textContent = "Full Song Database (800+)";
                renderBank(); 
            } else if (tabId !== 'live') {
                songBank.classList.remove('hidden');
                if(bankTitle) bankTitle.textContent = "Active Rotation";
                renderBank();
            }

            const tabs = ['current', 'custom', 'collaborate', 'originals', 'database', 'live'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(!btn) return;
                let cls = "flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none whitespace-nowrap ";
                if (t === tabId) {
                    if(tabId === 'live') cls += 'bg-yellow-900/50 text-yellow-100 border border-yellow-500';
                    else if(tabId === 'database') cls += 'bg-indigo-900/50 text-indigo-100 border border-indigo-500 ml-2';
                    else if(tabId === 'collaborate') cls += 'bg-purple-900/50 text-purple-100 border border-purple-500 shadow-lg';
                    else cls += 'bg-gray-700 text-white shadow';
                } 
                else {
                    if (t === 'live') cls += 'text-yellow-400 hover:text-white hover:bg-gray-750 border border-yellow-900/30';
                    else if(t === 'database') cls += 'text-gray-400 hover:text-white hover:bg-gray-750 border-l border-gray-600 ml-2';
                    else if(t === 'collaborate') cls += 'text-purple-400 hover:text-white hover:bg-gray-750 border border-purple-900/30';
                    else cls += 'text-gray-400 hover:text-white hover:bg-gray-750';
                }
                btn.className = cls;
            });
            
            if(tabId !== 'live' && tabId !== 'database') render();
            showToast(`Switched to ${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
        }

        window.exportCustomData = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.setCollections.custom));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "setlist_custom.json");
            dlAnchorElem.click();
        };

        window.importCustomData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data) && data.length === 4) {
                        window.setCollections.custom = data;
                        localStorage.setItem('myCustomSets', JSON.stringify(data));
                        window.switchTab('custom');
                        showToast("Custom sets loaded!");
                    } else { showToast("Invalid file format", true); }
                } catch(e) { showToast("Error parsing file", true); }
            };
            reader.readAsText(file);
        };
        
        window.resetToDefault = () => {
             if(confirm('Reset this tab to default?')) {
                 if(currentTab === 'custom') {
                     window.setCollections.custom = [[],[],[],[]];
                     localStorage.setItem('myCustomSets', JSON.stringify(window.setCollections.custom));
                 } else if (currentTab === 'collaborate') {
                     window.setCollections.collaborate = [[],[],[],[]];
                     window.updateCollaboration();
                 } else {
                     window.location.reload();
                 }
                 render();
                 showToast("Reset complete");
             }
        };

        window.clearAll = () => {
            if(confirm('Clear all songs in this tab?')) {
                window.setCollections[currentTab] = [[],[],[],[]];
                if(currentTab === 'custom') localStorage.setItem('myCustomSets', JSON.stringify(window.setCollections.custom));
                else if(currentTab === 'collaborate') window.updateCollaboration();
                render();
            }
        };

        window.downloadAllImage = async () => {
            showToast("Generating image...");
            const original = document.getElementById("sets-capture-area");
            const clone = original.cloneNode(true);
            clone.style.width = original.offsetWidth + 'px';
            clone.style.height = 'auto'; 
            clone.style.position = 'absolute';
            clone.style.top = '-10000px';
            clone.style.left = '0';
            clone.style.overflow = 'visible'; 
            
            const lists = clone.querySelectorAll('ul');
            lists.forEach(list => {
                list.style.maxHeight = 'none';
                list.style.overflow = 'visible';
                list.style.height = 'auto';
            });
            
            document.body.appendChild(clone);
            try {
                const canvas = await html2canvas(clone, {
                    backgroundColor: "#111827",
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    windowHeight: clone.scrollHeight + 100 
                });
                const link = document.createElement('a');
                link.download = `setlist-${currentTab}-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } catch(e) {
                console.error(e);
                showToast("Image generation failed", true);
            } finally {
                document.body.removeChild(clone);
            }
        };
        
        window.downloadSetImage = async (setIndex) => {
            showToast(`Capturing Set ${setIndex+1}...`);
            const original = document.getElementById(`set-container-${setIndex}`);
            const clone = original.cloneNode(true);
            clone.style.width = original.offsetWidth + 'px';
            clone.style.height = 'auto';
            clone.style.position = 'absolute';
            clone.style.top = '-10000px';
            clone.style.left = '0';
            const list = clone.querySelector('ul');
            if(list) {
                list.style.maxHeight = 'none';
                list.style.overflow = 'visible';
                list.style.height = 'auto';
            }
            document.body.appendChild(clone);
            try {
                const canvas = await html2canvas(clone, {
                    backgroundColor: "#1f2937",
                    scale: 2,
                    windowHeight: clone.scrollHeight + 50
                });
                const link = document.createElement('a');
                link.download = `set-${setIndex+1}-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } finally {
                document.body.removeChild(clone);
            }
        };

        // COPY FUNCTIONALITY
        let copySourceIndex = -1;
        window.openCopyModal = (index) => {
            copySourceIndex = index;
            document.getElementById('copy-modal').classList.remove('hidden');
        };

        window.executeCopy = (targetIndex) => {
            if (copySourceIndex === -1) return;
            const sourceSongs = window.setCollections[currentTab][copySourceIndex];
            const target = window.setCollections.custom[targetIndex];
            sourceSongs.forEach(s => target.push({...s}));
            localStorage.setItem('myCustomSets', JSON.stringify(window.setCollections.custom));
            document.getElementById('copy-modal').classList.add('hidden');
            showToast(`Copied Set ${copySourceIndex + 1} to Custom Set ${targetIndex + 1}`);
        };
        
        // QR Code
        const generateQR = () => {
            const qrEl = document.getElementById("qrcode");
            if (!qrEl) return;
            qrEl.innerHTML = "";
            const audienceUrl = window.location.href + (window.location.href.includes('?') ? '&' : '?') + "mode=audience";
            new QRCode(qrEl, {
                text: audienceUrl,
                width: 256,
                height: 256
            });
        };
        
        window.copyAudienceLink = () => {
            const audienceUrl = window.location.href + (window.location.href.includes('?') ? '&' : '?') + "mode=audience";
            const tempInput = document.createElement("input");
            tempInput.value = audienceUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            showToast("üîó Link copied to clipboard!");
        };

        // ==========================================
        // 6. LISTENERS & AUTH (DEFINED AFTER CORE LOGIC)
        // ==========================================
        window.toggleManagerMode = () => {
            if(window.managerMode) {
                window.managerMode = false;
                showToast("Manager Mode Locked");
                renderBank();
            } else {
                document.getElementById('pin-modal').classList.remove('hidden');
                document.getElementById('manager-pin-input').value = '';
                document.getElementById('manager-pin-input').focus();
            }
        };

        window.checkManagerPin = () => {
            const input = document.getElementById('manager-pin-input');
            if(input.value === "1234") {
                window.managerMode = true;
                showToast("Manager Mode Unlocked! üîì");
                document.getElementById('pin-modal').classList.add('hidden');
                renderBank();
            } else {
                showToast("Incorrect PIN", true);
                input.value = '';
            }
        };

        window.closePinModal = () => {
            document.getElementById('pin-modal').classList.add('hidden');
        };

        function startRotationListener() {
            if(!db) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rotation', 'list');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().songs) {
                    const cloudSongs = docSnap.data().songs;
                    if(Array.isArray(cloudSongs)) {
                        activeRotationList = cloudSongs.sort();
                        window.activeRotationList = activeRotationList; 
                        
                        if (currentTab !== 'database' && currentTab !== 'live') renderBank(); 
                        if (currentTab === 'database') renderBank();
                    }
                } else {
                    console.log("Initializing Cloud Rotation...");
                    setDoc(docRef, { songs: rawBankData.sort(), lastUpdated: Date.now() });
                }
            });
        }

        function startCollaborationListener() {
            if (!db) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'collaboration', 'sets');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && data.sets) {
                        try {
                            const parsed = typeof data.sets === 'string' ? JSON.parse(data.sets) : data.sets;
                            if (Array.isArray(parsed) && parsed.length === 4) {
                                window.setCollections.collaborate = parsed.map(s => Array.isArray(s) ? s : []);
                                if (currentTab === 'collaborate') render();
                            } else {
                                window.setCollections.collaborate = [[],[],[],[]];
                                if (currentTab === 'collaborate') render();
                            }
                        } catch(e) { 
                            console.error("Parse error", e); 
                            window.setCollections.collaborate = [[],[],[],[]];
                        }
                    }
                } else {
                    console.log("Initializing Collaboration Doc...");
                    window.setCollections.collaborate = [[],[],[],[]]; 
                    window.updateCollaboration();
                }
            });
        }

        async function initAuth() {
            if (!auth) return;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { 
                const statusEl = document.getElementById('firebase-status');
                if(statusEl) statusEl.innerHTML = `<span class="text-red-400 font-bold">‚ö†Ô∏è Auth Error</span>`;
            }
        }
        
        async function initDatabase() {
            const loading = document.getElementById('bank-loading');
            if(loading) loading.classList.remove('hidden');
            
            const CACHE_KEY = 'song_db_cache';
            const CACHE_TIME_KEY = 'song_db_time';
            const CACHE_DURATION = 24 * 60 * 60 * 1000;
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
            const isCacheValid = cachedTime && (Date.now() - parseInt(cachedTime) < CACHE_DURATION);

            if (cachedData && isCacheValid) {
                console.log("Loading DB from Local Cache");
                fullSongDatabase = JSON.parse(cachedData).sort();
                updateFullDB();
                finishInit(loading);
                return;
            }

            console.log("Fetching DB from GitHub...");
            try {
                const response = await fetch(MASTER_DB_URL);
                if(response.ok) {
                    const fetchedList = await response.json();
                    if(Array.isArray(fetchedList) && fetchedList.length > 0) {
                        fullSongDatabase = fetchedList.sort();
                        localStorage.setItem(CACHE_KEY, JSON.stringify(fullSongDatabase));
                        localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
                        updateFullDB();
                        console.log(`Loaded ${fullSongDatabase.length} songs from external DB.`);
                    }
                } else {
                    throw new Error("Fetch failed");
                }
            } catch(e) {
                console.warn("Could not fetch external DB.", e);
            } finally {
                finishInit(loading);
            }
        }

        function updateFullDB() {
            fullDatabaseKeys = [...new Set([...fullDatabaseKeys, ...fullSongDatabase])].sort();
            window.fullDatabase = fullDatabaseKeys; 
        }

        function finishInit(loadingEl) {
            if(loadingEl) loadingEl.classList.add('hidden');
            if(currentTab === 'database' || currentTab !== 'live') renderBank();
            const audienceInterface = document.getElementById('audience-interface');
            if(audienceInterface && !audienceInterface.classList.contains('hidden')) {
                window.renderAudienceBankFallback();
            }
        }

        // ==========================================
        // 7. ENTRY POINT
        // ==========================================
        window.onload = () => {
            if (auth) {
                initAuth();
                onAuthStateChanged(auth, (user) => {
                    window.currentUser = user;
                    if (user) {
                        console.log("Connected as", user.uid);
                        const statusEl = document.getElementById('firebase-status');
                        if(statusEl) statusEl.innerHTML = `<span class="text-green-400 animate-pulse">‚óè Online</span>`;
                        if(!window.location.search.includes('mode=audience')) {
                            startRequestListeners();
                            startCollaborationListener();
                            startRotationListener();
                        }
                    }
                });
            }

            initDatabase().then(() => {
                const params = new URLSearchParams(window.location.search);
                window.masterBank = activeRotationList; 
                window.fullDatabase = fullDatabaseKeys; 
                
                if(params.get('mode') === 'audience') {
                    document.getElementById('band-interface').classList.add('hidden');
                    document.getElementById('audience-interface').classList.remove('hidden');
                    window.renderAudienceBankFallback();
                } else {
                    renderBank(); 
                    switchTab('current');
                }
            });
        };
        
        // --- LYRICS CONFIG ---
        const LYRICS_GITHUB_BASE_URL = `https://raw.githubusercontent.com/Maltais239/interactives/main/songfiles/`;
        let scrollTimer = null;
        let scrollDelay = 50; 
        const minDelay = 10;
        const maxDelay = 150; 

        window.sanitizeId = (str) => str.toLowerCase().replace(/[^a-z0-9]/g, '_');

        window.stopScroll = () => {
            if (scrollTimer) clearInterval(scrollTimer);
            scrollTimer = null;
            const btn = document.getElementById('btn-autoscroll');
            if(btn) {
                btn.innerHTML = '‚ñ∂Ô∏è';
                btn.classList.remove('bg-red-600', 'text-white', 'border-red-500');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            }
        };
        
        window.openLyricsModal = async (title, artist) => {
            try {
                const modal = document.getElementById('lyrics-modal');
                const contentArea = document.getElementById('lyrics-content');
                const modalTitle = document.getElementById('lyrics-modal-title');
                const sourceBadge = document.getElementById('lyrics-source-badge');
                
                if(!modal) return;

                modalTitle.textContent = title;
                modal.classList.remove('hidden');
                
                if(typeof window.stopScroll === 'function') window.stopScroll();

                contentArea.innerHTML = '<div class="flex items-center justify-center h-40"><div class="spinner"></div><span class="text-gray-400 ml-2">Searching...</span></div>';
                document.getElementById('lyrics-view-mode').classList.remove('hidden');
                document.getElementById('lyrics-edit-mode').classList.add('hidden');
                sourceBadge.innerHTML = '';
                
                let lyricsContent = null;
                let source = 'none';

                if(db) {
                    try {
                        const songId = window.sanitizeId(title);
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'songs', songId);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists() && docSnap.data().content) {
                            lyricsContent = docSnap.data().content;
                            source = 'firebase';
                        }
                    } catch (e) { console.error("Firebase fetch error:", e); }
                }

                if (!lyricsContent) {
                    const cleanTitle = title.split('(')[0].trim();
                    const encodedTitle = encodeURIComponent(cleanTitle);
                    
                    // Try TXT first
                    try {
                        let res = await fetch(LYRICS_GITHUB_BASE_URL + encodedTitle + ".txt");
                        if (!res.ok && cleanTitle !== title) {
                             res = await fetch(LYRICS_GITHUB_BASE_URL + encodeURIComponent(title) + ".txt");
                        }
                        
                        if (res.ok) {
                            lyricsContent = await res.text();
                            source = 'github';
                        } else {
                            // Try DOCX as fallback
                            console.log("TXT not found, checking for DOCX...");
                            let docRes = await fetch(LYRICS_GITHUB_BASE_URL + encodedTitle + ".docx");
                            if (!docRes.ok && cleanTitle !== title) {
                                docRes = await fetch(LYRICS_GITHUB_BASE_URL + encodeURIComponent(title) + ".docx");
                            }

                            if (docRes.ok) {
                                const arrayBuffer = await docRes.arrayBuffer();
                                const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer}); 
                                lyricsContent = result.value;
                                source = 'github-docx';
                            }
                        }
                    } catch (e) { console.error("GitHub fetch error:", e); }
                }

                if (lyricsContent) {
                    window.renderLyrics(lyricsContent);
                    document.getElementById('lyrics-textarea').value = lyricsContent;
                    if(source === 'firebase') {
                        sourceBadge.innerHTML = '<span class="text-[10px] bg-indigo-900 text-indigo-300 px-2 py-1 rounded border border-indigo-700">Cloud Saved</span>';
                    } else if (source === 'github-docx') {
                        sourceBadge.innerHTML = '<span class="text-[10px] bg-blue-900 text-blue-200 px-2 py-1 rounded border border-blue-700">GitHub (DOCX)</span>';
                    } else {
                        sourceBadge.innerHTML = '<span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-1 rounded border border-gray-600">GitHub</span>';
                    }
                } else {
                    contentArea.innerHTML = `<div class="text-gray-500 italic text-center mt-10"><p class="mb-2">No lyrics found for "${title}"</p><button onclick="toggleEditMode()" class="mt-4 text-indigo-400 hover:text-white underline">Write Lyrics Now</button></div>`;
                    document.getElementById('lyrics-textarea').value = '';
                }
                window.currentLyricsSong = { title, artist, id: window.sanitizeId(title) };
            } catch(err) {
                console.error("OpenLyrics Error", err);
                showToast("Error opening lyrics", true);
            }
        };

        window.renderLyrics = (text) => {
            const html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>").replace(/(\[[A-G][b#]?[0-9]*[a-z]*\])/g, '<span class="text-yellow-400 font-bold">$1</span>');
            document.getElementById('lyrics-content').innerHTML = `<div class="font-mono text-sm whitespace-pre-wrap pb-40">${html}</div>`;
        };

        window.toggleEditMode = () => {
            window.stopScroll();
            const viewMode = document.getElementById('lyrics-view-mode');
            const editMode = document.getElementById('lyrics-edit-mode');
            if (viewMode.classList.contains('hidden')) {
                viewMode.classList.remove('hidden');
                editMode.classList.add('hidden');
            } else {
                viewMode.classList.add('hidden');
                editMode.classList.remove('hidden');
            }
        };

        window.saveLyrics = async () => {
            const text = document.getElementById('lyrics-textarea').value;
            const song = window.currentLyricsSong;
            if(!db || !song) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'songs', song.id);
                await setDoc(docRef, { title: song.title, artist: song.artist, content: text, lastUpdated: Date.now() }, { merge: true });
                window.renderLyrics(text);
                window.toggleEditMode();
                showToast("Lyrics saved!");
            } catch (e) { showToast("Error saving lyrics.", true); }
        };
        
        window.toggleAutoScroll = () => {
            const btn = document.getElementById('btn-autoscroll');
            if (scrollTimer) {
                window.stopScroll();
            } else {
                if(btn) {
                    btn.innerHTML = '‚è∏Ô∏è';
                    btn.classList.add('bg-red-600', 'text-white', 'border-red-500');
                    btn.classList.remove('bg-gray-700', 'text-gray-300');
                }
                const container = document.getElementById('lyrics-view-mode');
                const doScroll = () => {
                    container.scrollTop += 1;
                    if(container.scrollTop + container.clientHeight >= container.scrollHeight) window.stopScroll();
                };
                scrollTimer = setInterval(doScroll, scrollDelay);
            }
        };

        window.changeSpeed = (delta) => {
            scrollDelay += delta;
            if (scrollDelay < minDelay) scrollDelay = minDelay;
            if (scrollDelay > maxDelay) scrollDelay = maxDelay;
            const speedDisplay = document.getElementById('scroll-speed-display');
            if(speedDisplay) {
                const percentage = Math.round(((maxDelay - scrollDelay) / (maxDelay - minDelay)) * 100);
                speedDisplay.innerText = percentage + '%';
            }
            if (scrollTimer) {
                clearInterval(scrollTimer);
                const container = document.getElementById('lyrics-view-mode');
                scrollTimer = setInterval(() => {
                    container.scrollTop += 1;
                    if(container.scrollTop + container.clientHeight >= container.scrollHeight) window.stopScroll();
                }, scrollDelay);
            }
        };
        
        window.closeLyricsModal = () => {
            window.stopScroll();
            document.getElementById('lyrics-modal').classList.add('hidden');
        };
        
        // --- REQUESTS ---
        window.addAudienceRequest = async (song, artist, source = 'new') => {
            if (!db) return false;
            const normalizedSong = song.trim(); 
            const deviceID = localStorage.getItem('deviceID') || crypto.randomUUID();
            if(!localStorage.getItem('deviceID')) localStorage.setItem('deviceID', deviceID);
            
            const storageKey = `voted_${normalizedSong.replace(/[^a-zA-Z0-9]/g, '')}`;
            const lastVoted = localStorage.getItem(storageKey);
            const COOLDOWN_MS = 15 * 60 * 1000;
            
            if (lastVoted && (Date.now() - parseInt(lastVoted) < COOLDOWN_MS)) {
                showToast(`You already requested "${normalizedSong}".`, true);
                return false;
            }

            try {
                const requestsRef = collection(db, 'artifacts', appId, 'public', 'data', 'requests');
                const q = query(requestsRef, where("song", "==", normalizedSong));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    await updateDoc(snapshot.docs[0].ref, { votes: increment(1), timestamp: Date.now() });
                } else {
                    await addDoc(requestsRef, {
                        song: normalizedSong,
                        artist: (artist || '').trim(),
                        votes: 1,
                        timestamp: Date.now(),
                        source: source,
                        voterID: deviceID
                    });
                }
                localStorage.setItem(storageKey, Date.now().toString());
                showToast(`Request for "${normalizedSong}" sent!`);
                return true;
            } catch (e) { console.error(e); showToast("Error sending request.", true); return false; }
        };
        
        window.submitNewRequest = () => {
            const songInput = document.getElementById('audience-new-song');
            const artistInput = document.getElementById('audience-artist');
            const song = songInput.value.trim();
            const artist = artistInput.value.trim();

            if (!song) return showToast("Please enter a song title.", true);
            
            // --- STRICT VALIDATION ---
            // 1. Minimum Length 3
            if (song.length < 3) return showToast("Song title is too short.", true);
            
            // 2. Context Rule: If title is short (like 'Smee'), Artist is REQUIRED.
            if (song.length < 5 && !artist) {
                return showToast("For short titles, please add the Artist name.", true);
            }

            window.addAudienceRequest(song, artist, 'custom').then(success => {
                if (success) {
                    songInput.value = '';
                    artistInput.value = '';
                    songInput.blur();
                    artistInput.blur();
                    
                    const successMsg = document.getElementById('request-success');
                    successMsg.classList.remove('hidden');
                    setTimeout(() => successMsg.classList.add('hidden'), 3000);
                }
            });
        };
        
        window.renderAudienceBankFallback = () => {
             const list = document.getElementById('audience-bank-list');
             if(!list) return;
             const source = window.activeRotationList || [];
             list.innerHTML = source.map(s => {
                 const safe = s.replace(/'/g, "\\'");
                 return `
                    <div onclick="window.addAudienceRequest('${safe}', '', 'bank')" class="p-3 border-b border-white/10 text-gray-300 hover:bg-white/10 active:bg-indigo-600 active:text-white transition cursor-pointer flex justify-between items-center group">
                        <span>${s}</span>
                        <span class="opacity-0 group-hover:opacity-100 text-indigo-400 text-xs font-bold">REQUEST +</span>
                    </div>
                 `;
             }).join('');
        };

        async function deleteRequest(id) {
            if (!db) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', id)); showToast("Request cleared."); } catch (e) { showToast("Error clearing.", true); }
        }
        
        async function clearAllRequests() {
            if (!db || !confirm("Clear ALL pending requests?")) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'requests'));
            const s = await getDocs(q);
            const b = writeBatch(db);
            s.forEach(d => b.delete(d.ref));
            await b.commit();
            showToast("Requests cleared.");
        }

        function startRequestListeners() {
            if(!db) return;
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'requests')), (s) => {
                const r = []; s.forEach(d => r.push({id: d.id, ...d.data()}));
                r.sort((a,b) => (b.votes||0)-(a.votes||0) || (a.timestamp||0)-(b.timestamp||0));
                if (typeof window.renderIncomingRequests === 'function') window.renderIncomingRequests(r);
            });
        }
        
        window.renderIncomingRequests = (requests) => {
            const list = document.getElementById('requests-list');
            if(!list) return;
            const liveBadge = document.querySelector('#live-controls .bg-red-500');
            if(liveBadge) liveBadge.textContent = requests.length > 0 ? `${requests.length} New` : 'Live';

            if(requests.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-500 py-10 italic">No requests yet.</div>`;
            } else {
                list.innerHTML = requests.map(r => {
                    const originTag = r.source === 'bank' ? `<span class="text-xs bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded-full mr-2">Bank</span>` : `<span class="text-xs bg-red-500/20 text-red-300 px-2 py-1 rounded-full mr-2">New</span>`;
                    const voteBadge = r.votes > 1 ? `<span class="bg-green-600 text-white text-xs px-2 py-1 rounded-full font-bold ml-2">${r.votes} Votes</span>` : '';
                    return `
                        <div class="bg-gray-700/50 p-3 rounded-lg flex justify-between items-start border border-gray-600 animate-fade-in">
                            <div><div class="font-bold text-white flex items-center">${r.song}${voteBadge}</div><div class="mt-2 text-xs text-gray-500 flex items-center">${originTag} <span class="text-pink-300 ml-2">${new Date(r.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div></div>
                            <div class="flex flex-col gap-1"><button onclick="window.saveRequestToSet('${r.song.replace(/'/g, "\\'")}', '', '${r.id}')" class="text-xs bg-indigo-600 text-white px-2 py-1 rounded">Save</button><button onclick="window.deleteRequest('${r.id}')" class="text-xs bg-gray-600 hover:bg-red-500 text-white px-2 py-1 rounded">Clear</button></div>
                        </div>`;
                }).join('');
            }
        };
        window.deleteRequest = deleteRequest;
        window.clearAllRequests = clearAllRequests;
        
        // --- 7. PIN MODAL ---
        window.managerMode = false;
        window.toggleManagerMode = () => {
            if(window.managerMode) {
                window.managerMode = false;
                showToast("Manager Mode Locked");
                renderBank();
            } else {
                document.getElementById('pin-modal').classList.remove('hidden');
                document.getElementById('manager-pin-input').value = '';
                document.getElementById('manager-pin-input').focus();
            }
        };

        window.checkManagerPin = () => {
            const input = document.getElementById('manager-pin-input');
            if(input.value === "1234") {
                window.managerMode = true;
                showToast("Manager Mode Unlocked! üîì");
                document.getElementById('pin-modal').classList.add('hidden');
                renderBank();
            } else {
                showToast("Incorrect PIN", true);
                input.value = '';
            }
        };

        window.closePinModal = () => {
            document.getElementById('pin-modal').classList.add('hidden');
        };

    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans selection:bg-indigo-500 selection:text-white pb-20">

    <!-- === BAND INTERFACE === -->
    <div id="band-interface" class="container mx-auto max-w-6xl p-4 md:p-8">
        
        <!-- Header -->
        <header class="mb-6 text-center flex flex-col md:flex-row justify-between items-center md:items-end border-b border-gray-700 pb-4 gap-4">
            <div class="text-left w-full md:w-auto flex flex-col items-center md:items-start">
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">Setlist Creator 3.0.2</h1>
                <h2 class="text-sm font-bold text-indigo-300 opacity-75">Active Rotation & Database</h2>
                <div class="flex flex-col md:flex-row gap-4 mt-2 items-center md:items-start">
                    <p class="text-gray-400 text-sm mt-1">4 Sets ‚Ä¢ Active Rotation ‚Ä¢ Full DB</p>
                    <div class="flex gap-2 items-center text-xs font-bold bg-gray-800 px-3 py-1 rounded-full border border-gray-700">
                        <span class="text-gray-500 uppercase tracking-wide mr-1">Vocals:</span>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> <span class="text-green-400">Darren</span></div>
                        <div class="flex items-center gap-1 ml-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> <span class="text-blue-400">Jeff</span></div>
                        <div class="flex items-center gap-1 ml-2"><span class="w-2 h-2 rounded-full bg-pink-500"></span> <span class="text-pink-400">Melissa</span></div>
                    </div>
                    <div id="firebase-status" class="text-xs font-mono border border-gray-700 rounded px-2 py-0.5 flex items-center text-gray-500">‚óè Offline</div>
                </div>
            </div>
            
            <div class="flex gap-2 no-print items-center flex-wrap justify-end">
                <button onclick="downloadAllImage()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded text-xs font-bold transition shadow-lg flex items-center gap-1">
                    <span>üì∑</span> Save Img
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6 flex space-x-1 bg-gray-800 p-1 rounded-xl no-print tab-nav overflow-x-auto">
            <button onclick="switchTab('current')" id="tab-current" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-white bg-gray-700 shadow whitespace-nowrap">Current Sets</button>
            <button onclick="switchTab('live')" id="tab-live" class="flex-1 py-2 px-4 rounded-lg text-sm font-bold transition focus:outline-none text-yellow-400 hover:text-white hover:bg-gray-750 border border-yellow-900/30 whitespace-nowrap flex items-center justify-center gap-2"><span class="animate-pulse">‚óè</span> Live Mode</button>
            <button onclick="switchTab('custom')" id="tab-custom" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-gray-400 hover:text-white hover:bg-gray-750 whitespace-nowrap">Create Your Own</button>
            <button onclick="switchTab('collaborate')" id="tab-collaborate" class="flex-1 py-2 px-4 rounded-lg text-sm font-bold transition focus:outline-none text-purple-400 hover:text-white hover:bg-gray-750 border border-purple-900/30 whitespace-nowrap flex items-center justify-center gap-2">üë• Collaborate</button>
            <button onclick="switchTab('originals')" id="tab-originals" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-gray-400 hover:text-white hover:bg-gray-750 whitespace-nowrap">Originals</button>
            <button onclick="switchTab('database')" id="tab-database" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-gray-400 hover:text-white hover:bg-gray-750 whitespace-nowrap border-l border-gray-600 ml-2 pl-6">üìö Database (800+)</button>
        </div>

        <!-- Collaborate Header Info -->
        <div id="collaborate-info" class="hidden mb-6 bg-purple-900/20 border border-purple-700/50 p-4 rounded-xl flex items-center justify-between">
            <div class="text-purple-300 text-sm">
                <span class="font-bold">Live Sync Active:</span> Changes made here update instantly for all band members.
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.clearAll()" class="text-xs bg-purple-800 hover:bg-purple-700 text-white px-2 py-1 rounded border border-purple-600">Clear All</button>
                <div class="text-xs text-purple-400 animate-pulse">‚óè Syncing</div>
            </div>
        </div>

        <!-- Custom Controls -->
        <div id="custom-controls" class="no-print mb-6 hidden">
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 flex flex-wrap gap-4 items-center justify-between">
                <div class="text-sm text-gray-400"><span class="text-indigo-400 font-bold">Auto-Save:</span> Enabled.</div>
                <div class="flex gap-3">
                    <button onclick="exportCustomData()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm">Save to File</button>
                    <label class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm cursor-pointer">
                        Load from File <input type="file" id="import-file" class="hidden" accept=".json" onchange="importCustomData(this)">
                    </label>
                </div>
            </div>
        </div>

        <!-- LIVE CONTROLS -->
        <div id="live-controls" class="no-print mb-6 hidden animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gray-800 p-6 rounded-xl border border-yellow-500/30 shadow-lg shadow-yellow-900/10 flex flex-col items-center justify-center text-center">
                    <h3 class="text-yellow-400 font-bold text-lg mb-2">Audience Access</h3>
                    <div class="bg-white p-4 rounded-lg mb-4"><div id="qrcode"></div></div>
                    <button onclick="copyAudienceLink()" class="mt-2 bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded-full transition flex items-center gap-1">
                        <span>üîó</span> Copy Link
                    </button>
                    <p class="text-gray-400 text-xs mt-3">Scan to Request Songs</p>
                </div>
                <div class="md:col-span-2 bg-gray-800 p-6 rounded-xl border border-gray-700 flex flex-col h-[400px]">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                        <h3 class="font-bold text-white flex items-center gap-2">Incoming Requests <span class="bg-red-500 text-white text-[10px] px-2 rounded-full animate-pulse">Live</span></h3>
                        <button onclick="window.clearAllRequests()" class="text-xs text-gray-500 hover:text-red-400 transition-colors font-bold">Clear ALL Requests (Permanent)</button>
                    </div>
                    <div id="requests-list" class="flex-grow overflow-y-auto space-y-2"><div class="text-center text-gray-500 py-10 italic">Waiting for audience requests...</div></div>
                </div>
            </div>
        </div>

        <!-- Sets Grid -->
        <div id="sets-capture-area" class="p-2 -m-2 bg-gray-900">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-12">
                <div id="set-container-0" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col"><div class="p-4 bg-gray-800 border-b border-gray-700"><h2 class="text-xl font-bold text-green-400">Set 1</h2></div><ul id="list-set-0" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow min-h-[50px]"></ul></div>
                <div id="set-container-1" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col"><div class="p-4 bg-gray-800 border-b border-gray-700"><h2 class="text-xl font-bold text-green-400">Set 2</h2></div><ul id="list-set-1" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow min-h-[50px]"></ul></div>
                <div id="set-container-2" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col"><div class="p-4 bg-gray-800 border-b border-gray-700"><h2 class="text-xl font-bold text-green-400">Set 3</h2></div><ul id="list-set-2" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow min-h-[50px]"></ul></div>
                <div id="set-container-3" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col"><div class="p-4 bg-gray-800 border-b border-gray-700"><h2 class="text-xl font-bold text-green-400">Set 4</h2></div><ul id="list-set-3" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow min-h-[50px]"></ul></div>
            </div>
        </div>
        
        <!-- Song Input -->
        <div id="input-section" class="no-print bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
            <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold mb-4 border-b border-gray-700 pb-2">Add New / Custom Song</h3>
            <form id="add-song-form" class="flex flex-col md:flex-row gap-4 items-end" onsubmit="event.preventDefault(); addNewSong();">
                <div class="flex-grow w-full">
                    <label class="block text-xs uppercase tracking-wide text-gray-500 font-bold mb-2">Song Title & Artist</label>
                    <input type="text" id="song-title" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:border-indigo-500 transition" placeholder="e.g. White Christmas" required>
                </div>
                <div class="w-full md:w-40">
                    <label class="block text-xs uppercase tracking-wide text-gray-500 font-bold mb-2">Add To</label>
                    <select id="target-set" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:border-indigo-500 transition">
                        <option value="0">Set 1</option>
                        <option value="1">Set 2</option>
                        <option value="2">Set 3</option>
                        <option value="3">Set 4</option>
                    </select>
                </div>
                <button type="submit" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg transition shadow-lg">Add</button>
            </form>
        </div>

        <!-- Master Song Bank -->
        <div id="song-bank-section" class="no-print bg-gray-900 border border-gray-700 rounded-xl shadow-2xl overflow-hidden hidden">
            <div class="p-6 bg-gray-800 border-b border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2">
                    <h2 class="text-2xl font-bold text-indigo-400" id="bank-title">Active Rotation</h2>
                    <!-- MANAGER LOCK -->
                    <button onclick="toggleManagerMode()" class="text-gray-500 hover:text-white text-lg transition-colors" title="Manager Access">
                        <span id="manager-lock-icon">üîí</span>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <span id="bank-loading" class="text-xs text-yellow-400 hidden animate-pulse">Syncing...</span>
                    <input type="text" id="bank-search" oninput="renderBank()" class="w-full md:w-64 bg-gray-900 text-white border border-gray-600 rounded-full py-2 px-4 focus:outline-none focus:border-indigo-500 text-sm" placeholder="Search...">
                </div>
            </div>
            <div class="p-6 bg-gray-850">
                <p class="text-gray-400 text-xs mb-4">Click numbered buttons to add songs to specific sets.</p>
                <div id="bank-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>
        </div>

        <div class="mt-8 text-center no-print">
            <button onclick="resetToDefault()" class="text-indigo-400 hover:text-indigo-300 text-sm underline transition mr-4">Reset Current Tab</button>
            <button onclick="clearAll()" class="text-red-400 hover:text-red-300 text-sm underline transition">Clear Current Tab</button>
        </div>
    </div>

    <!-- === AUDIENCE INTERFACE (Mobile First) === -->
    <div id="audience-interface" class="hidden min-h-screen bg-gradient-to-br from-gray-900 via-indigo-900 to-black p-4 pb-20">
        <div class="max-w-md mx-auto flex flex-col h-[90vh]">
            <header class="text-center mb-4 pt-6 flex-shrink-0">
                <h1 class="text-3xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-yellow-300 to-pink-500 drop-shadow-sm">Request A Song</h1>
                <p class="text-indigo-200 text-sm mt-1 font-medium">Tap a song to request it live!</p>
            </header>

            <!-- Success Message -->
            <div id="request-success" class="hidden fixed top-6 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-8 py-4 rounded-full shadow-2xl z-50 flex items-center gap-2 animate-bounce font-bold border-2 border-green-400">
                <span>‚úÖ Request Sent!</span>
            </div>

            <!-- Song Bank (Swapped to TOP) -->
            <div class="glass rounded-2xl border border-white/10 overflow-hidden shadow-2xl flex flex-col flex-grow mb-6">
                <div class="p-4 bg-black/40 border-b border-white/10 flex justify-between items-center">
                    <span class="font-bold text-gray-300 text-sm uppercase tracking-wide">Available Songs</span>
                    <span class="text-xs text-indigo-400 bg-indigo-900/50 px-2 py-1 rounded-full border border-indigo-700/50">Scroll to browse</span>
                </div>
                <div id="audience-bank-list" class="overflow-y-auto flex-grow p-1 space-y-1">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Custom Request Form (Swapped to BOTTOM) -->
            <div class="glass p-5 rounded-2xl border border-white/10 shadow-xl flex-shrink-0">
                <h3 class="font-bold text-white mb-3 text-sm uppercase tracking-wide opacity-80">Can't find it? Request something new:</h3>
                <div class="space-y-3">
                    <input type="text" id="audience-new-song" placeholder="Song Title" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-white placeholder-gray-500 focus:border-indigo-400 focus:ring-1 focus:ring-indigo-400 outline-none transition-all">
                    <input type="text" id="audience-artist" placeholder="Artist (Optional)" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-white placeholder-gray-500 focus:border-indigo-400 focus:ring-1 focus:ring-indigo-400 outline-none transition-all">
                    <button id="btn-submit-new" onclick="submitNewRequest()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-95 transition-all">Send Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pin-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 shadow-2xl w-full max-w-xs text-center">
            <h3 class="text-xl font-bold text-white mb-4">Manager Access</h3>
            <input type="password" id="manager-pin-input" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white mb-4 text-center tracking-widest text-xl focus:border-indigo-500 outline-none" placeholder="Enter PIN" maxlength="4">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="checkManagerPin()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded-lg">Unlock</button>
                <button onclick="closePinModal()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast & Copy Modal -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50"><span id="toast-message">Action successful</span></div>
    
    <div id="copy-modal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center backdrop-blur-sm"><div class="bg-gray-800 p-6 rounded-xl border border-gray-600 shadow-2xl w-full max-w-sm"><h3 class="text-xl font-bold text-white mb-2">Copy Set to "Create Your Own"</h3><div class="grid grid-cols-2 gap-3 mb-4"><button onclick="executeCopy(0)" class="bg-gray-700 hover:bg-indigo-600 hover:text-white p-3 rounded-lg border border-gray-600">Set 1</button><button onclick="executeCopy(1)" class="bg-gray-700 hover:bg-indigo-600 hover:text-white p-3 rounded-lg border border-gray-600">Set 2</button><button onclick="executeCopy(2)" class="bg-gray-700 hover:bg-indigo-600 hover:text-white p-3 rounded-lg border border-gray-600">Set 3</button><button onclick="executeCopy(3)" class="bg-gray-700 hover:bg-indigo-600 hover:text-white p-3 rounded-lg border border-gray-600">Set 4</button></div><button onclick="document.getElementById('copy-modal').classList.add('hidden')" class="w-full text-gray-500 hover:text-gray-300 py-2 text-sm">Cancel</button></div></div>

    <!-- Lyrics Modal -->
    <div id="lyrics-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col">
        <!-- Header -->
        <div class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0 shadow-lg z-10">
            <div class="flex flex-col">
                <h3 id="lyrics-modal-title" class="text-xl font-bold text-white leading-tight">Song Title</h3>
                <div id="lyrics-source-badge" class="mt-1"></div>
            </div>
            <button onclick="closeLyricsModal()" class="text-gray-400 hover:text-white text-3xl font-bold px-4 leading-none">&times;</button>
        </div>

        <!-- Toolbar -->
        <div class="bg-gray-900 p-2 border-b border-gray-800 flex justify-between items-center flex-shrink-0 overflow-x-auto z-10">
            <div class="flex items-center gap-2">
                <button onclick="changeSpeed(10)" class="text-sm bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded font-bold w-10">-</button>
                <div class="flex flex-col items-center w-16">
                    <span class="text-[10px] text-gray-500 uppercase tracking-wider">Speed</span>
                    <span id="scroll-speed-display" class="font-bold text-indigo-400 text-sm">50%</span>
                </div>
                <button onclick="changeSpeed(-10)" class="text-sm bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded font-bold w-10">+</button>
            </div>
            
            <div class="flex gap-3">
                <button id="btn-autoscroll" onclick="toggleAutoScroll()" class="text-xl bg-gray-700 hover:bg-gray-600 text-gray-300 w-12 h-10 rounded flex items-center justify-center transition-colors shadow-sm">‚ñ∂Ô∏è</button>
                <button onclick="toggleEditMode()" class="bg-indigo-900 hover:bg-indigo-800 text-indigo-200 px-4 py-2 rounded text-xs border border-indigo-700 font-bold tracking-wide">EDIT</button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-grow relative overflow-hidden bg-black">
            <!-- View Mode -->
            <div id="lyrics-view-mode" class="absolute inset-0 overflow-y-auto p-4 md:p-8 text-center scroll-smooth">
                <div id="lyrics-content" class="text-xl md:text-3xl text-gray-200 leading-relaxed font-sans whitespace-pre-wrap pb-[60vh] max-w-3xl mx-auto"></div>
            </div>

            <!-- Edit Mode -->
            <div id="lyrics-edit-mode" class="absolute inset-0 hidden flex flex-col p-4 bg-gray-900 z-20">
                <textarea id="lyrics-textarea" class="flex-grow bg-gray-800 text-white font-mono text-sm p-4 rounded border border-gray-700 focus:border-indigo-500 outline-none resize-none shadow-inner" placeholder="Paste lyrics here..."></textarea>
                <div class="flex justify-end pt-4 gap-3">
                    <button onclick="toggleEditMode()" class="text-gray-400 hover:text-white px-4 py-2">Cancel</button>
                    <button onclick="saveLyrics()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded font-bold shadow-lg">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
