<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set List Creator 2.1 (Live Connected)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // --- Firebase Config ---
        // Extracted directly from your screenshot (image_bf03f2.png)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB-_e7l_7LTDjU4zBCCNunGIRyf2zyTvhw",
            authDomain: "set-list-creator-ef3d8.firebaseapp.com",
            projectId: "set-list-creator-ef3d8",
            storageBucket: "set-list-creator-ef3d8.firebasestorage.app",
            messagingSenderId: "221159083280",
            appId: "1:221159083280:web:b39791e126d8282d176995",
            measurementId: "G-S31RSM312F"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'setlist-v2-demo';

        // Init Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            window.db = db; // Expose for non-module script
            window.auth = auth;
            window.appId = appId;
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        // --- DISPLAY LOGIC ---
        window.renderIncomingRequests = (requests) => {
            const list = document.getElementById('requests-list');
            if(!list) return; // Not in band view
            
            // Update badge count
            const liveBadge = document.querySelector('#live-controls .bg-red-500');
            if(liveBadge) liveBadge.textContent = requests.length > 0 ? `${requests.length} New` : 'Live';

            if(requests.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-500 py-10 italic">No requests yet.</div>`;
            } else {
                list.innerHTML = requests.map(r => `
                    <div class="bg-gray-700/50 p-3 rounded-lg flex justify-between items-center border border-gray-600 animate-fade-in">
                        <div>
                            <div class="font-bold text-white">${r.song}</div>
                            ${r.artist ? `<div class="text-xs text-gray-400">${r.artist}</div>` : ''}
                        </div>
                        <div class="flex flex-col items-end gap-1">
                             <div class="text-xs bg-pink-500/20 text-pink-300 px-2 py-1 rounded">
                                ${new Date(r.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        };

        // Auth Logic
        async function initAuth() {
            if (!auth) return;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { 
                console.error("Auth Error:", error); 
                const statusEl = document.getElementById('firebase-status');
                if(statusEl) {
                    const code = error.code || error.message || "Unknown Error";
                    statusEl.innerHTML = `<span class="text-red-400 font-bold" title="${error.message}">‚ö†Ô∏è ${code}</span>`;
                }
            }
        }

        if (auth) {
            initAuth();
            onAuthStateChanged(auth, (user) => {
                window.currentUser = user;
                if (user) {
                    console.log("Connected as", user.uid);
                    const statusEl = document.getElementById('firebase-status');
                    if(statusEl) statusEl.innerHTML = '<span class="text-green-400 animate-pulse">‚óè Live</span>';
                    
                    if(!window.location.search.includes('mode=audience')) {
                        startRequestListeners();
                    }
                }
            });
        }

        // Database Helpers
        window.addAudienceRequest = async (song, artist) => {
            if(!db) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), {
                    song: song,
                    artist: artist,
                    votes: 1,
                    timestamp: Date.now()
                });
            } catch(e) { console.error(e); alert("Error sending request"); }
        };

        function startRequestListeners() {
            if(!db) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), orderBy('votes', 'desc'));
            onSnapshot(q, (snapshot) => {
                const requests = [];
                snapshot.forEach(doc => requests.push({id: doc.id, ...doc.data()}));
                if (typeof window.renderIncomingRequests === 'function') {
                    window.renderIncomingRequests(requests);
                }
            }, (error) => {
                console.error("Firestore Listen Error:", error);
            });
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .sortable-ghost { opacity: 0.4; background: #374151; }
        .sortable-drag { cursor: grabbing; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans selection:bg-indigo-500 selection:text-white pb-20">

    <!-- === BAND INTERFACE (Set List Creator) === -->
    <div id="band-interface" class="container mx-auto max-w-6xl p-4 md:p-8">
        
        <!-- Header -->
        <header class="mb-6 text-center flex flex-col md:flex-row justify-between items-end border-b border-gray-700 pb-4 gap-4">
            <div class="text-left">
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">Set List Creator 2.1</h1>
                <div class="flex flex-col md:flex-row gap-4 mt-2">
                    <p class="text-gray-400 text-sm mt-1">4 Sets ‚Ä¢ Total Time: <span id="grand-total-time" class="text-white font-mono">0:00:00</span></p>
                    
                    <!-- Singer Legend -->
                    <div class="flex gap-2 items-center text-xs font-bold bg-gray-800 px-3 py-1 rounded-full border border-gray-700">
                        <span class="text-gray-500 uppercase tracking-wide mr-1">Vocals:</span>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> <span class="text-green-400">Darren</span></div>
                        <div class="flex items-center gap-1 ml-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> <span class="text-blue-400">Jeff</span></div>
                        <div class="flex items-center gap-1 ml-2"><span class="w-2 h-2 rounded-full bg-pink-500"></span> <span class="text-pink-400">Melissa</span></div>
                    </div>
                    
                    <div id="firebase-status" class="text-xs font-mono border border-gray-700 rounded px-2 py-0.5 flex items-center text-gray-500">‚óè Offline</div>
                </div>
            </div>
            <div class="flex gap-3 no-print items-center flex-wrap justify-end">
                <button onclick="activateTwoStep()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm flex items-center gap-2 border border-red-500 shadow-lg shadow-red-900/20 font-bold animate-pulse hover:animate-none">üö® Two Step</button>
                <button onclick="activate50s()" class="bg-teal-600 hover:bg-teal-500 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm flex items-center gap-2 border border-teal-500 shadow-lg shadow-teal-900/20 font-bold animate-pulse hover:animate-none">üé∏ 50s</button>
                <button onclick="activatePopHits()" class="bg-pink-600 hover:bg-pink-500 text-white px-3 py-2 rounded-lg transition text-xs md:text-sm flex items-center gap-2 border border-pink-500 shadow-lg shadow-pink-900/20 font-bold animate-pulse hover:animate-none">üé§ Pop</button>
                <div class="w-px h-8 bg-gray-700 mx-2 hidden md:block"></div>
                <button onclick="downloadAllImage()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg transition text-sm flex items-center gap-2 border border-indigo-500 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                    Save Image
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6 flex space-x-1 bg-gray-800 p-1 rounded-xl no-print tab-nav overflow-x-auto">
            <button onclick="switchTab('christmas')" id="tab-christmas" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-white bg-gray-700 shadow whitespace-nowrap">Christmas Party</button>
            <button onclick="switchTab('custom')" id="tab-custom" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-gray-400 hover:text-white hover:bg-gray-750 whitespace-nowrap">Create Your Own</button>
            <button onclick="switchTab('originals')" id="tab-originals" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none text-gray-400 hover:text-white hover:bg-gray-750 whitespace-nowrap">Originals</button>
            
            <!-- Hidden Emergency Tabs -->
            <button onclick="switchTab('twostep')" id="tab-twostep" class="hidden flex-1 py-2 px-4 rounded-lg text-sm font-bold transition focus:outline-none text-red-400 hover:text-white hover:bg-gray-750 border border-red-900/30 whitespace-nowrap">üö® Two Step</button>
            <button onclick="switchTab('fifties')" id="tab-fifties" class="hidden flex-1 py-2 px-4 rounded-lg text-sm font-bold transition focus:outline-none text-teal-400 hover:text-white hover:bg-gray-750 border border-teal-900/30 whitespace-nowrap">üé∏ 50s</button>
            <button onclick="switchTab('pophits')" id="tab-pophits" class="hidden flex-1 py-2 px-4 rounded-lg text-sm font-bold transition focus:outline-none text-pink-400 hover:text-white hover:bg-gray-750 border border-pink-900/30 whitespace-nowrap">üé§ Pop Hits</button>
            
            <!-- NEW LIVE TAB -->
            <button onclick="switchTab('live')" id="tab-live" class="flex-1 py-2 px-4 rounded-lg text-sm font-bold transition focus:outline-none text-yellow-400 hover:text-white hover:bg-gray-750 border border-yellow-900/30 whitespace-nowrap flex items-center justify-center gap-2">
                <span class="animate-pulse">‚óè</span> Live Mode
            </button>
        </div>

        <!-- Custom Controls -->
        <div id="custom-controls" class="no-print mb-6 hidden">
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 flex flex-wrap gap-4 items-center justify-between">
                <div class="text-sm text-gray-400"><span class="text-indigo-400 font-bold">Auto-Save:</span> Enabled.</div>
                <div class="flex gap-3">
                    <button onclick="exportCustomData()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm">Save to File</button>
                    <label class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm cursor-pointer">
                        Load from File <input type="file" id="import-file" class="hidden" accept=".json" onchange="importCustomData(this)">
                    </label>
                </div>
            </div>
        </div>

        <!-- LIVE CONTROLS -->
        <div id="live-controls" class="no-print mb-6 hidden animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- QR Code Area -->
                <div class="bg-gray-800 p-6 rounded-xl border border-yellow-500/30 shadow-lg shadow-yellow-900/10 flex flex-col items-center justify-center text-center">
                    <h3 class="text-yellow-400 font-bold text-lg mb-2">Audience Access</h3>
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <div id="qrcode"></div>
                    </div>
                    <p class="text-gray-400 text-xs">Scan to Request Songs</p>
                </div>
                
                <!-- Incoming Requests Area -->
                <div class="md:col-span-2 bg-gray-800 p-6 rounded-xl border border-gray-700 flex flex-col h-[400px]">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                        <h3 class="font-bold text-white flex items-center gap-2">
                            Incoming Requests <span class="bg-red-500 text-white text-[10px] px-2 rounded-full animate-pulse">Live</span>
                        </h3>
                        <button onclick="if(window.renderIncomingRequests) window.renderIncomingRequests([])" class="text-xs text-gray-500 hover:text-white">Clear View</button>
                    </div>
                    <div id="requests-list" class="flex-grow overflow-y-auto space-y-2">
                        <div class="text-center text-gray-500 py-10 italic">Waiting for audience requests...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Song Input -->
        <div id="input-section" class="no-print bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
            <h3 class="text-sm uppercase tracking-wide text-gray-400 font-bold mb-4 border-b border-gray-700 pb-2">Add New / Custom Song</h3>
            <form id="add-song-form" class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label class="block text-xs uppercase tracking-wide text-gray-500 font-bold mb-2">Song Title & Artist</label>
                    <input type="text" id="song-title" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:border-indigo-500 transition" placeholder="e.g. White Christmas" required>
                </div>
                <div class="w-full md:w-32">
                    <label class="block text-xs uppercase tracking-wide text-gray-500 font-bold mb-2">Time</label>
                    <input type="text" id="song-duration" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:border-indigo-500 transition text-center" placeholder="3:30">
                </div>
                <div class="w-full md:w-40">
                    <label class="block text-xs uppercase tracking-wide text-gray-500 font-bold mb-2">Add To</label>
                    <select id="target-set" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg py-3 px-4 focus:outline-none focus:border-indigo-500 transition">
                        <option value="0">Set 1</option>
                        <option value="1">Set 2</option>
                        <option value="2">Set 3</option>
                        <option value="3">Set 4</option>
                    </select>
                </div>
                <button type="submit" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg transition shadow-lg">Add</button>
            </form>
        </div>

        <!-- Sets Grid -->
        <div id="sets-capture-area" class="p-2 -m-2 bg-gray-900">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12">
                <!-- Sets 1-4 generated by JS -->
                <div id="set-container-0" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col"><div class="p-4 bg-gray-800 border-b border-gray-700"><h2 class="text-xl font-bold text-green-400">Set 1</h2></div><ul id="list-set-0" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow min-h-[50px]"></ul></div>
                <div id="set-container-1" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col"><div class="p-4 bg-gray-800 border-b border-gray-700"><h2 class="text-xl font-bold text-green-400">Set 2</h2></div><ul id="list-set-1" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow min-h-[50px]"></ul></div>
                <div id="set-container-2" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col"><div class="p-4 bg-gray-800 border-b border-gray-700"><h2 class="text-xl font-bold text-green-400">Set 3</h2></div><ul id="list-set-2" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow min-h-[50px]"></ul></div>
                <div id="set-container-3" class="set-container bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-700 flex flex-col"><div class="p-4 bg-gray-800 border-b border-gray-700"><h2 class="text-xl font-bold text-green-400">Set 4</h2></div><ul id="list-set-3" class="divide-y divide-gray-700 overflow-y-auto max-h-[600px] flex-grow min-h-[50px]"></ul></div>
            </div>
        </div>

        <!-- Master Song Bank -->
        <div id="song-bank-section" class="no-print bg-gray-900 border border-gray-700 rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 bg-gray-800 border-b border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-bold text-indigo-400">Master Song Bank</h2>
                <input type="text" id="bank-search" oninput="renderBank()" class="w-full md:w-64 bg-gray-900 text-white border border-gray-600 rounded-full py-2 px-4 focus:outline-none focus:border-indigo-500 text-sm" placeholder="Search song bank...">
            </div>
            <div class="p-6 bg-gray-850">
                <div id="bank-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>
        </div>

        <div class="mt-8 text-center no-print">
            <button onclick="resetToDefault()" class="text-indigo-400 hover:text-indigo-300 text-sm underline transition mr-4">Reset Current Tab</button>
            <button onclick="clearAll()" class="text-red-400 hover:text-red-300 text-sm underline transition">Clear Current Tab</button>
        </div>
    </div>

    <!-- === AUDIENCE INTERFACE (Hidden by default, shown via URL param) === -->
    <div id="audience-interface" class="hidden min-h-screen bg-gray-900 p-6 flex flex-col items-center justify-center">
        <div class="max-w-md w-full space-y-8 text-center">
            <div>
                <h2 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500">
                    Live Requests
                </h2>
                <p class="mt-2 text-gray-400">Tell the band what you want to hear!</p>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-700">
                <input id="audience-song" type="text" placeholder="Song Name" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white mb-3 focus:border-pink-500 outline-none">
                <input id="audience-artist" type="text" placeholder="Artist (Optional)" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white mb-4 focus:border-pink-500 outline-none">
                <button onclick="submitRequest()" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold py-3 rounded-lg transition transform active:scale-95">
                    Send Request üöÄ
                </button>
            </div>

            <div id="request-success" class="hidden text-green-400 font-bold bg-green-900/30 p-4 rounded-lg">
                Request Sent!
            </div>
        </div>
    </div>

    <!-- Toast & Hidden Elements -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toast-message">Action successful</span>
    </div>

    <!-- Modal: Copy Set -->
    <div id="copy-modal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold text-white mb-2">Copy Set to "Create Your Own"</h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="executeCopy(0)" class="bg-gray-700 hover:bg-indigo-600 hover:text-white p-3 rounded-lg border border-gray-600">Set 1</button>
                <button onclick="executeCopy(1)" class="bg-gray-700 hover:bg-indigo-600 hover:text-white p-3 rounded-lg border border-gray-600">Set 2</button>
                <button onclick="executeCopy(2)" class="bg-gray-700 hover:bg-indigo-600 hover:text-white p-3 rounded-lg border border-gray-600">Set 3</button>
                <button onclick="executeCopy(3)" class="bg-gray-700 hover:bg-indigo-600 hover:text-white p-3 rounded-lg border border-gray-600">Set 4</button>
            </div>
            <button onclick="document.getElementById('copy-modal').classList.add('hidden')" class="w-full text-gray-500 hover:text-gray-300 py-2 text-sm">Cancel</button>
        </div>
    </div>

    <script>
        // --- DATA SECTION ---
        const christmasData = [
            [{ title: "Cleopatra (The Lumineers)", durationStr: "0:00" }, { title: "Island In The Sun (Weezer)", durationStr: "0:00" }, { title: "Ahead By A Century (Tragically Hip)", durationStr: "0:00" }, { title: "Blue Christmas (Elvis Presley)", durationStr: "0:00" }, { title: "Dont Walk Away Eileen (Sam Roberts)", durationStr: "0:00" }, { title: "A Little Something (Melissa Majeau)", durationStr: "0:00" }, { title: "Green River (CCR)", durationStr: "0:00" }, { title: "Flowers (Miley Cyrus)", durationStr: "0:00" }, { title: "Dancing In The Dark (Bruce Springsteen)", durationStr: "0:00" }, { title: "Blow At High Dough (Tragically Hip)", durationStr: "0:00" }, { title: "ALL APOLOGIES (Nirvana)", durationStr: "0:00" }, { title: "I Need Never Get Old (Nathaniel Rateliff)", durationStr: "0:00" }, { title: "Santa Bring My Baby Back To Me (Elvis)", durationStr: "0:00" }, { title: "Dreams (Fleetwood Mac)", durationStr: "0:00" }, { title: "Folsom Prison Blues (Johnny Cash)", durationStr: "0:00" }, { title: "My Babe (Willie Dixon / Little Walter)", durationStr: "0:00" }, { title: "Harvest Moon (Neil Young)", durationStr: "0:00" }, { title: "Jolene (Dolly Parton)", durationStr: "0:00" }, { title: "Colors (Black Pumas)", durationStr: "0:00" }],
            [{ title: "SOMETHING IN THE ORANGE (Zach Bryan)", durationStr: "0:00" }, { title: "Christmas (Baby Please Come Home) (Darlene Love)", durationStr: "0:00" }, { title: "Don't Want to Wait (Darren Maltais)", durationStr: "0:00" }, { title: "Layla (Derek and the Dominos)", durationStr: "0:00" }, { title: "I'm On Fire (Bruce Springsteen)", durationStr: "0:00" }, { title: "Those Days (Darren Maltais)", durationStr: "0:00" }, { title: "Jingle Bell Rock (Bobby Helms)", durationStr: "0:00" }, { title: "You Wreck Me (Tom Petty)", durationStr: "0:00" }, { title: "Steal My Kisses (Ben Harper)", durationStr: "0:00" }, { title: "Blank Space (Ryan Adams)", durationStr: "0:00" }, { title: "Pride And Joy (Stevie Ray Vaughan)", durationStr: "0:00" }, { title: "Tonight in Black and White (Jeff McLellan)", durationStr: "0:00" }, { title: "Santa Claus Is Coming To Town (Bruce Springsteen)", durationStr: "0:00" }, { title: "REAL LOVE BABY (Father John Misty)", durationStr: "0:00" }, { title: "Five Dollar Bill (Corb Lund)", durationStr: "0:00" }, { title: "Cadillac Ranch (Bruce Springsteen)", durationStr: "0:00" }, { title: "American Girl (Tom Petty)", durationStr: "0:00" }, { title: "Get Back (The Beatles)", durationStr: "0:00" }, { title: "King Of The Road (Dean Martin/Roger Miller)", durationStr: "0:00" }, { title: "Heart of Glass (Blondie)", durationStr: "0:00" }, { title: "Johnny B. Goode (Chuck Berry)", durationStr: "0:00" }, { title: "Rhiannon (Fleetwood Mac)", durationStr: "0:00" }, { title: "No Bright Light (Darren Maltais)", durationStr: "0:00" }, { title: "Blister In The Sun (Violent Femmes)", durationStr: "0:00" }],
            [{ title: "Cry Me A River (Justin Timberlake)", durationStr: "0:00" }, { title: "Back To Black (Amy Winehouse)", durationStr: "0:00" }, { title: "Can't Let Go (Lucinda Williams)", durationStr: "0:00" }, { title: "No Diggity (Blackstreet)", durationStr: "0:00" }, { title: "I Shot The Sheriff (Bob Marley)", durationStr: "0:00" }, { title: "Hand it over (Darren Maltais)", durationStr: "0:00" }, { title: "That's All Right Mama (Elvis Presley)", durationStr: "0:00" }, { title: "Runaround Sue (Dion)", durationStr: "0:00" }, { title: "Zombie (The Cranberries)", durationStr: "0:00" }, { title: "You Can't Judge A Book By The Cover (Bo Diddley)", durationStr: "0:00" }, { title: "Fishin' In The Dark (Nitty Gritty Dirt Band)", durationStr: "0:00" }, { title: "Paper Planes (M.I.A.)", durationStr: "0:00" }, { title: "Blitzkrieg Bop (The Ramones)", durationStr: "0:00" }, { title: "Day Tripper (The Beatles)", durationStr: "0:00" }, { title: "Driving My Life Away (Eddie Rabbitt)", durationStr: "0:00" }, { title: "Beautiful things (Darren Maltais)", durationStr: "0:00" }, { title: "Blindman River (Melissa Majeau)", durationStr: "0:00" }, { title: "Tennessee Whiskey (Chris Stapleton)", durationStr: "0:00" }, { title: "Another Road Home (Jeff McLellan)", durationStr: "0:00" }, { title: "Oh Boy (Buddy Holly)", durationStr: "0:00" }, { title: "Life Of Sin (Sturgill Simpson)", durationStr: "0:00" }, { title: "Hungry Like The Wolf (Duran Duran)", durationStr: "0:00" }],
            [{ title: "Paranoid (Black Sabbath)", durationStr: "0:00" }, { title: "It Takes a Lot to Laugh (Bob Dylan)", durationStr: "0:00" }, { title: "Flowers In Your Hair (The Lumineers)", durationStr: "0:00" }, { title: "Faith (Wham)", durationStr: "0:00" }, { title: "Still Falling (Jeff McLellan)", durationStr: "0:00" }, { title: "Driving My Life Away (Reprise?)", durationStr: "0:00" }, { title: "Norwegian Wood (The Beatles)", durationStr: "0:00" }, { title: "Bottom Feeders (Melissa Majeau)", durationStr: "0:00" }, { title: "Creep (Radiohead)", durationStr: "0:00" }, { title: "S.O.B. (Nathaniel Rateliff)", durationStr: "0:00" }, { title: "What'd I Say (Ray Charles)", durationStr: "0:00" }, { title: "Long Ride (Melissa Majeau)", durationStr: "0:00" }, { title: "The Thrill Is Gone (BB King)", durationStr: "0:00" }, { title: "Rocket Man (Elton John)", durationStr: "0:00" }]
        ];
        
        const originalsData = [[],[],[],[]];
        const jeffSongs = ["Tonight in Black and White (Jeff McLellan)", "Still Fallin' (Jeff McLellan)", "Before Our Graves (Jeff McLellan)", "Another Road Home (Jeff McLellan)", "Havens to Hendrix (Jeff McLellan)", "Spark (Jeff McLellan)", "Blindman River (Jeff McLellan)"];
        const melissaSongs = ["A Little Something (Melissa Majeau)", "Blindman River (Melissa Majeau)", "Bottom Feeders (Melissa Majeau)", "Long Ride (Melissa Majeau)", "No Denial (Melissa Majeau)", "Sugar Daddy (Melissa Majeau)"];
        const darrenSongs = ["No Bright Light (Darren Maltais)", "Hand it Over (Darren Maltais)", "Beautiful Things (Darren Maltais)", "Don't Want to Wait (Darren Maltais)", "A Simple Thing (Darren Maltais)", "Is Your Heart a Map (Darren Maltais)", "Just Another Number (Darren Maltais)", "Lonesome Grave (Darren Maltais)", "I Wonder (Darren Maltais)", "Memento (Darren Maltais)"];
        originalsData[0] = jeffSongs.map(t => ({ title: t, durationStr: "0:00" }));
        originalsData[1] = melissaSongs.map(t => ({ title: t, durationStr: "0:00" }));
        originalsData[2] = darrenSongs.map(t => ({ title: t, durationStr: "0:00" }));

        // Emergency Data
        const twoStepData = [
            ["Folsom Prison Blues", "Fishin' in the Dark", "Driving My Life Away", "Cadillac Ranch", "Green River", "Ring of Fire", "I Walk the Line"].map(t => ({title:t, durationStr:"0:00"})),
            ["Jambalaya", "Wagon Wheel", "Five Dollar Bill", "Guitar Town", "Looking Out My Back Door", "Midnight Rider", "That's Alright"].map(t => ({title:t, durationStr:"0:00"})),
            ["Copperhead Road", "Boot Scootin' Boogie", "Chattahoochee", "Neon Moon", "Friends in Low Places"].map(t => ({title:t, durationStr:"0:00"})),
            []
        ];
        const fiftiesData = [
            ["Johnny B. Goode", "Runaround Sue", "That's Alright", "Oh Boy"].map(t => ({title:t, durationStr:"0:00"})),
            ["You Can't Judge a Book", "My Babe", "Blue Christmas"].map(t => ({title:t, durationStr:"0:00"})),
            ["Blue Suede Shoes", "Great Balls of Fire", "Hound Dog", "La Bamba", "Twist and Shout"].map(t => ({title:t, durationStr:"0:00"})),
            []
        ];
        const popHitsData = [
            ["Flowers (Miley Cyrus)", "Blank Space", "Hey Ya", "Seven Nation Army"].map(t => ({title:t, durationStr:"0:00"})),
            ["No Diggity", "Paper Planes", "Steal My Kisses", "Zombie", "Use Somebody"].map(t => ({title:t, durationStr:"0:00"})),
            ["Uptown Funk", "Mr. Brightside", "Shut Up and Dance", "Sweet Caroline"].map(t => ({title:t, durationStr:"0:00"})),
            []
        ];

        // State
        let customData = [[], [], [], []];
        let currentTab = 'christmas'; 
        let setCollections = {
            christmas: JSON.parse(JSON.stringify(christmasData)),
            custom: customData,
            originals: JSON.parse(JSON.stringify(originalsData)),
            twostep: JSON.parse(JSON.stringify(twoStepData)),
            fifties: JSON.parse(JSON.stringify(fiftiesData)),
            pophits: JSON.parse(JSON.stringify(popHitsData)),
            live: [[],[],[],[]] // Dummy for live tab
        };
        
        let sortables = [];

        // Load custom data
        if(localStorage.getItem('myCustomSets')) {
            try { setCollections.custom = JSON.parse(localStorage.getItem('myCustomSets')); } catch(e) {}
        }

        // Master Bank
        const rawBankData = ["A Little Something (Melissa Majeau)", "A Simple Thing (Darren Maltais)", "Ahead by a Century", "All Apologies", "American Girl (Tom Petty)", "Another Road Home", "Back to Black", "Beautiful Things", "Before our Graves", "Big River", "Blank Space (Ryan Adams)", "Blindman River", "Blister in the Sun", "Blitzkrieg Bop", "Blow at High Dough", "Blue Christmas", "Bobcaygeon", "Bottom Feeders", "Brown Eyed Girl", "Cadillac Ranch", "Can't Let Go", "Christmas (Baby Please Come Home)", "Cleopatra", "Creep", "Cry Me a River", "Dancing in the Dark", "Day Tripper", "Don't Walk Away Eileen", "Don't Want to Wait (Darren Maltais)", "Dreams", "Drivin' my Life Away", "Faith", "Fishin' in the Dark", "Five Dollar Bill", "Flowers", "Flowers in your Hair", "Folsom Prison Blues", "Get Back", "Green River", "Guitar Town", "Hand it Over", "Harvest Moon", "Heart of Glass", "Hey Ya", "Hungry Like the Wolf", "I Shot the Sheriff", "I Walk the Line", "I Wonder (Darren Maltais)", "I'm on Fire", "Is Your Heart a Map (Darren Maltais)", "Island In The Sun", "It Takes a lot to Laugh", "Jambalaya", "Jingle Bell Rock", "Johnny B. Goode", "Jolene", "Just Another Number (Darren Maltais)", "King of the Road", "Layla", "Life of Sin", "Little Lion Man", "Lonesome Grave (Darren Maltais)", "Long Ride", "Looking Out My Back Door", "Memento (Darren Maltais)", "Midnight Rider", "My Babe", "Need Never Get Old", "No Bright Light", "No Denial (Melissa Majeau)", "No Diggity", "Norwegian Wood", "Oh Boy", "Paper Planes", "Paranoid", "Pride and Joy", "Real Love Baby", "Rhiannon", "Ring of Fire", "Rocket Man", "Runaround Sue", "Santa Bring My Baby Back To Me", "Santa Claus Is Coming To Town", "Seven Nation Army", "SOB", "Something in the Orange", "Spark (Darren Maltais)", "Steal My Kisses", "Still Fallin'", "Sugar Daddy (Melissa Majeau)", "Tennessee Whiskey", "That's Alright", "The Thrill is Gone", "Those Days", "Tonight in Black and White", "Valerie", "Wagon Wheel", "What'd I say?", "White Christmas", "You Can't Judge a Book", "You Wreck Me", "Zombie"];
        const masterBank = rawBankData.sort();

        // --- GLOBAL FUNCTIONS (Defined BEFORE usage) ---
        
        // --- SINGER / VOCALIST LOGIC ---
        const singerMap = {
            "Ahead By A Century": "Jeff",
            "Blow At High Dough": "Jeff",
            "All Apologies": "Jeff",
            "ALL APOLOGIES": "Jeff",
            "I'm On Fire": "D/M", 
            "Dreams": "Melissa",
            "Jolene": "Melissa",
            "Heart of Glass": "Melissa",
            "Rhiannon": "Melissa",
            "Blister In The Sun": "Jeff",
            "Can't Let Go": "Melissa",
            "Cant Let Go": "Melissa",
            "I Shot The Sheriff": "Jeff",
            "You Wreck Me": "Jeff",
            "Norwegian Wood": "Jeff",
            "Johnny B. Goode": "Jeff",
            "Johnny B Goode": "Jeff",
            "Brown Eyed Girl": "Jeff",
            "Cadillac Ranch": "Jeff",
            "Flowers": "Melissa",
            "Valerie": "Melissa",
            "Layla": "Jeff",
            "Blindman River": "Melissa",
            "Zombie": "Melissa"
        };

        function getSinger(titleStr) {
            const cleanTitle = titleStr.toLowerCase();
            for (const [key, value] of Object.entries(singerMap)) {
                if (cleanTitle.includes(key.toLowerCase())) {
                    return value;
                }
            }
            if (cleanTitle.includes("jeff mclellan")) return "Jeff";
            if (cleanTitle.includes("melissa majeau")) return "Melissa";
            if (cleanTitle.includes("darren maltais")) return "Darren";
            return "Darren";
        }
        
        function getSingerBadgeHTML(singer) {
            if (singer === 'Jeff') {
                return `<span class="singer-badge inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-500/20 text-blue-400 text-xs font-bold mr-2 no-print flex-shrink-0" title="Jeff">J</span>`;
            } else if (singer === 'Melissa') {
                return `<span class="singer-badge inline-flex items-center justify-center w-6 h-6 rounded-full bg-pink-500/20 text-pink-400 text-xs font-bold mr-2 no-print flex-shrink-0" title="Melissa">M</span>`;
            } else if (singer === 'D/M') {
                return `<span class="singer-badge inline-flex items-center justify-center w-8 h-6 rounded-full bg-gradient-to-r from-green-500/20 to-pink-500/20 text-white text-[10px] font-bold mr-2 no-print flex-shrink-0" title="Duet (Darren/Melissa)">D/M</span>`;
            } else {
                return `<span class="singer-badge inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-500/20 text-green-400 text-xs font-bold mr-2 no-print flex-shrink-0" title="Darren">D</span>`;
            }
        }
        // ----------------------------------------------------

        window.renderBank = () => {
            const search = document.getElementById('bank-search').value.toLowerCase();
            const filtered = masterBank.filter(s => s.toLowerCase().includes(search));
            document.getElementById('bank-list').innerHTML = filtered.map(s => {
                const singer = getSinger(s);
                const badgeHTML = getSingerBadgeHTML(singer);
                return `
                <div class="bg-gray-800 border border-gray-700 p-2 rounded flex justify-between items-center group hover:bg-gray-750">
                    <div class="flex items-center overflow-hidden mr-2">
                        ${badgeHTML}
                        <span class="text-sm text-gray-300 truncate" title="${s}">${s}</span>
                    </div>
                    <div class="flex gap-1 opacity-50 group-hover:opacity-100 transition-opacity">
                        <button onclick="addFromBank('${s.replace(/'/g, "\\'")}', 0)" class="text-[10px] bg-gray-700 hover:bg-indigo-600 w-5 h-5 rounded">1</button>
                        <button onclick="addFromBank('${s.replace(/'/g, "\\'")}', 1)" class="text-[10px] bg-gray-700 hover:bg-indigo-600 w-5 h-5 rounded">2</button>
                        <button onclick="addFromBank('${s.replace(/'/g, "\\'")}', 2)" class="text-[10px] bg-gray-700 hover:bg-indigo-600 w-5 h-5 rounded">3</button>
                        <button onclick="addFromBank('${s.replace(/'/g, "\\'")}', 3)" class="text-[10px] bg-gray-700 hover:bg-indigo-600 w-5 h-5 rounded">4</button>
                    </div>
                </div>`
            }).join('');
        };
        
        window.addFromBank = (t, i) => {
            setCollections[currentTab][i].push({title: t, durationStr: "0:00"});
            if(currentTab==='custom') localStorage.setItem('myCustomSets', JSON.stringify(setCollections.custom));
            render();
            showToast("Added to Set " + (i+1));
        };

        window.updateDuration = (si, songi, val) => {
            setCollections[currentTab][si][songi].durationStr = val;
            if(currentTab==='custom') localStorage.setItem('myCustomSets', JSON.stringify(setCollections.custom));
            render();
        };

        window.deleteSong = (si, songi) => {
            setCollections[currentTab][si].splice(songi, 1);
            if(currentTab==='custom') localStorage.setItem('myCustomSets', JSON.stringify(setCollections.custom));
            render();
        };

        window.downloadSetImage = (index) => {
            const element = document.getElementById(`set-container-${index}`);
            showToast("Processing image...");
            html2canvas(element, {
                scale: 2,
                backgroundColor: "#1f2937",
                useCORS: true,
                onclone: (clonedDoc) => {
                    const container = clonedDoc.getElementById(`set-container-${index}`);
                    const list = clonedDoc.getElementById(`list-set-${index}`);
                    if (container) {
                        container.style.height = 'auto';
                        container.style.overflow = 'visible';
                        container.style.paddingBottom = '40px';
                    }
                    if (list) {
                        list.style.maxHeight = 'none';
                        list.style.overflow = 'visible';
                    }
                    const overflowHidden = container.querySelectorAll('.overflow-hidden');
                    overflowHidden.forEach(el => { el.style.overflow = 'visible'; el.style.height = 'auto'; });
                    const textItems = container.querySelectorAll('.truncate');
                    textItems.forEach(el => {
                        el.style.whiteSpace = 'normal'; el.style.overflow = 'visible'; el.style.textOverflow = 'clip'; el.style.lineHeight = '1.5'; el.style.paddingBottom = '5px'; el.style.display = 'block';
                    });
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `set-${index+1}-${currentTab}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showToast("Set saved!");
            }).catch(err => {
                console.error(err);
                showToast("Error generating image");
            });
        };

        window.downloadAllImage = () => {
            window.scrollTo(0,0);
            const element = document.getElementById('sets-capture-area');
            showToast("Processing full image...");
            html2canvas(element, { 
                backgroundColor: "#111827",
                scale: 2,
                onclone: (clonedDoc) => {
                    const containers = clonedDoc.querySelectorAll('.set-container');
                    containers.forEach(container => { container.style.height = 'auto'; container.style.overflow = 'visible'; container.style.marginBottom = '40px'; });
                    const lists = clonedDoc.querySelectorAll('ul[id^="list-set-"]');
                    lists.forEach(list => { list.style.maxHeight = 'none'; list.style.overflow = 'visible'; });
                    const overflowHidden = clonedDoc.querySelectorAll('.overflow-hidden');
                    overflowHidden.forEach(el => { el.style.overflow = 'visible'; el.style.height = 'auto'; });
                    const textItems = clonedDoc.querySelectorAll('.truncate');
                    textItems.forEach(el => {
                        el.style.whiteSpace = 'normal'; el.style.overflow = 'visible'; el.style.textOverflow = 'clip'; el.style.lineHeight = '1.5'; el.style.paddingBottom = '5px'; el.style.display = 'block';
                    });
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `setlist-full-${currentTab}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showToast("Image downloaded!");
            }).catch(err => {
                console.error(err);
                showToast("Error generating image");
            });
        };

        // --- APP LOGIC ---

        function switchTab(tabId) {
            currentTab = tabId;
            const customControls = document.getElementById('custom-controls');
            const liveControls = document.getElementById('live-controls');
            const setsArea = document.getElementById('sets-capture-area');
            const inputSection = document.getElementById('input-section');
            const songBank = document.getElementById('song-bank-section');
            
            // Toggle Views
            customControls.classList.add('hidden');
            liveControls.classList.add('hidden');
            setsArea.classList.remove('hidden');
            inputSection.classList.remove('hidden');
            songBank.classList.remove('hidden');

            if(tabId === 'custom') customControls.classList.remove('hidden');
            
            if(tabId === 'live') {
                liveControls.classList.remove('hidden');
                setsArea.classList.add('hidden');     // Hide regular sets
                inputSection.classList.add('hidden'); // Hide input
                songBank.classList.add('hidden');     // Hide bank
                generateQR(); // Make sure QR is ready
            }

            // Tab Styles
            ['christmas', 'custom', 'originals', 'twostep', 'fifties', 'pophits', 'live'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(!btn) return;
                btn.className = "flex-1 py-2 px-4 rounded-lg text-sm font-medium transition focus:outline-none whitespace-nowrap ";
                
                if (t === tabId) {
                    if(tabId === 'live') btn.classList.add('bg-yellow-900/50', 'text-yellow-100', 'shadow', 'border', 'border-yellow-500');
                    else if(tabId === 'twostep') btn.classList.add('bg-red-900/50', 'text-red-100', 'shadow', 'border', 'border-red-500');
                    else if (tabId === 'fifties') btn.classList.add('bg-teal-900/50', 'text-teal-100', 'shadow', 'border', 'border-teal-500');
                    else if (tabId === 'pophits') btn.classList.add('bg-pink-900/50', 'text-pink-100', 'shadow', 'border', 'border-pink-500');
                    else btn.classList.add('text-white', 'bg-gray-700', 'shadow');
                } else {
                    if (t === 'live') btn.classList.add('text-yellow-400', 'hover:text-white', 'hover:bg-gray-750', 'border', 'border-yellow-900/30');
                    else if(t === 'twostep' || t === 'fifties' || t === 'pophits') {
                        // Emergency tabs visibility handled by class toggle
                        btn.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-gray-750', btn.classList.contains('hidden') ? 'hidden' : 'block');
                    }
                    else btn.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-gray-750');
                }
            });
            
            if(tabId !== 'live') render();
            showToast(`Switched to ${tabId}`);
        }

        // --- CORE FUNCTIONS (Render, Drag, Calculate) ---
        function render() {
            sortables.forEach(s => s.destroy());
            sortables = [];
            let grandTotalSeconds = 0;
            const activeSets = setCollections[currentTab];

            for(let i=0; i<4; i++) {
                const listEl = document.getElementById(`list-set-${i}`);
                if(!listEl) continue;
                
                const setSongs = activeSets[i];
                let setSeconds = 0;
                setSongs.forEach(s => setSeconds += timeToSeconds(s.durationStr));
                grandTotalSeconds += setSeconds;

                // Update Header Time
                const container = document.getElementById(`set-container-${i}`);
                const timeSpan = container.querySelector('.font-mono');
                if(timeSpan) timeSpan.textContent = secondsToTime(setSeconds);
                else {
                    // Inject time span if missing (first run)
                    const headerDiv = container.querySelector('.p-4');
                    const title = headerDiv.querySelector('h2').innerText;
                    const titleClass = headerDiv.querySelector('h2').className;
                    const copyBtn = currentTab !== 'custom' ? `<button onclick="openCopyModal(${i})" class="text-indigo-400 hover:text-white p-1 ml-2 text-xs font-bold" title="Copy">COPY</button>` : '';
                    headerDiv.innerHTML = `
                        <h2 class="${titleClass}">${title}</h2>
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-gray-400 bg-gray-900 px-2 py-1 rounded text-sm">${secondsToTime(setSeconds)}</span>
                            <div class="flex gap-1 no-print">
                                ${copyBtn}
                                <button onclick="downloadSetImage(${i})" class="text-gray-400 hover:text-white p-1" title="Save Image">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                                </button>
                            </div>
                        </div>`;
                }

                listEl.innerHTML = '';
                if(setSongs.length === 0) listEl.innerHTML = `<li class="p-4 text-gray-500 text-center text-sm italic">Empty Set</li>`;
                else {
                    setSongs.forEach((song, idx) => {
                        const singer = getSinger(song.title);
                        const badgeHTML = getSingerBadgeHTML(singer);

                        listEl.innerHTML += `
                            <li class="group flex items-center justify-between p-3 hover:bg-gray-750 transition border-l-4 border-transparent hover:border-indigo-500 bg-gray-800 odd:bg-gray-800 even:bg-gray-800/50" data-title="${song.title}">
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <div class="drag-handle cursor-grab text-gray-600 hover:text-gray-400 no-print">‚ò∞</div>
                                    <span class="text-gray-500 font-mono text-xs w-5 text-right no-print select-none">${idx + 1}.</span>
                                    <div class="truncate text-gray-200 text-sm md:text-base print-black flex items-center" title="${song.title}">
                                        ${badgeHTML}
                                        ${song.title}
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <input type="text" value="${song.durationStr === '0:00' ? '' : song.durationStr}" placeholder="0:00"
                                        class="duration-input w-12 bg-transparent text-right text-cyan-400 font-mono text-sm focus:outline-none focus:text-white placeholder-gray-600 no-print"
                                        onchange="updateDuration(${i}, ${idx}, this.value)">
                                    <span class="hidden print-block text-sm font-mono text-black">${song.durationStr}</span>
                                    <button onclick="deleteSong(${i}, ${idx})" class="p-1 hover:text-red-400 text-gray-600 opacity-0 group-hover:opacity-100 transition no-print">√ó</button>
                                </div>
                            </li>`;
                    });
                }
            }
            document.getElementById('grand-total-time').textContent = secondsToTime(grandTotalSeconds);
            
            // Init Sortable
            for(let i=0; i<4; i++) {
                const el = document.getElementById(`list-set-${i}`);
                if(el) sortables.push(new Sortable(el, { group: 'shared', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: handleDragDrop }));
            }
        }

        function handleDragDrop() {
            const newSets = [[], [], [], []];
            for(let i=0; i<4; i++) {
                const items = document.getElementById(`list-set-${i}`).querySelectorAll('li[data-title]');
                items.forEach(item => {
                    const title = item.getAttribute('data-title');
                    const durVal = item.querySelector('.duration-input').value || "0:00";
                    newSets[i].push({ title, durationStr: durVal });
                });
            }
            setCollections[currentTab] = newSets;
            if(currentTab === 'custom') localStorage.setItem('myCustomSets', JSON.stringify(newSets));
            render();
        }

        // --- LIVE & AUDIENCE FEATURES ---
        function generateQR() {
            const container = document.getElementById('qrcode');
            if(container.innerHTML !== "") return; // Already generated
            const url = window.location.href.split('?')[0] + "?mode=audience";
            new QRCode(container, { text: url, width: 200, height: 200 });
        }

        function submitRequest() {
            const song = document.getElementById('audience-song').value;
            const artist = document.getElementById('audience-artist').value;
            if(!song) return alert("Please enter a song name");
            
            window.addAudienceRequest(song, artist);
            
            document.getElementById('audience-song').value = '';
            document.getElementById('audience-artist').value = '';
            document.getElementById('request-success').classList.remove('hidden');
            setTimeout(() => document.getElementById('request-success').classList.add('hidden'), 3000);
        }

        // --- UTILS & INIT ---
        function timeToSeconds(str) {
            if(!str) return 0;
            const p = str.split(':').reverse();
            return (parseInt(p[0])||0) + ((parseInt(p[1])||0)*60);
        }
        function secondsToTime(s) {
            const m = Math.floor(s/60);
            const sec = (s%60).toString().padStart(2,'0');
            return `${m}:${sec}`;
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // --- EMERGENCY BUTTONS ---
        function activateTwoStep() { document.getElementById('tab-twostep').classList.remove('hidden'); switchTab('twostep'); }
        function activate50s() { document.getElementById('tab-fifties').classList.remove('hidden'); switchTab('fifties'); }
        function activatePopHits() { document.getElementById('tab-pophits').classList.remove('hidden'); switchTab('pophits'); }
        
        // --- COPY & ADD ---
        let sourceSetToCopy = null;
        function openCopyModal(i) { sourceSetToCopy = i; document.getElementById('copy-modal').classList.remove('hidden'); }
        function executeCopy(targetI) {
            if(sourceSetToCopy === null) return;
            const songs = setCollections[currentTab][sourceSetToCopy];
            setCollections.custom[targetI] = setCollections.custom[targetI].concat(JSON.parse(JSON.stringify(songs)));
            localStorage.setItem('myCustomSets', JSON.stringify(setCollections.custom));
            document.getElementById('copy-modal').classList.add('hidden');
            showToast("Set copied!");
        }

        // --- INIT LOGIC ---
        window.addEventListener('load', () => {
            // Check for Audience Mode
            const params = new URLSearchParams(window.location.search);
            if(params.get('mode') === 'audience') {
                document.getElementById('band-interface').classList.add('hidden');
                document.getElementById('audience-interface').classList.remove('hidden');
                document.title = "Make a Request - SetList Live";
            } else {
                // Band Mode
                renderBank();
                switchTab('christmas');
            }
        });
    </script>
</body>
</html>
